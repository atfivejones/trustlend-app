<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Promissory Note - TrustLend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .input-focus:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .step-active {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
        }
        .step-completed {
            background-color: #22c55e;
            color: white;
        }
        .step-inactive {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .signature-canvas {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: crosshair;
            background: #fafafa;
        }
        .payment-breakdown {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
        }
        .ucc-section {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border: 2px solid #f59e0b;
        }
        .legal-warning {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-900">TrustLend</span>
                </a>
                
                <div class="flex items-center space-x-4">
                    <button onclick="saveDraft()" class="text-gray-600 hover:text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Save Draft
                    </button>
                    <a href="dashboard.html" class="text-gray-600 hover:text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div id="step-1" class="step-active flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">1</div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-2" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">2</div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-3" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">3</div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-4" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">4</div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-5" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">5</div>
                </div>
                <div class="text-sm text-gray-600">Step <span id="current-step">1</span> of 5</div>
            </div>
            <div class="mt-4">
                <div id="step-label" class="text-lg font-semibold text-gray-900">Loan Details</div>
                <div id="step-description" class="text-sm text-gray-600">Enter the basic loan information</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Form Section -->
            <div class="space-y-6">
                <!-- Step 1: Loan Details -->
                <div id="form-step-1" class="bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Loan Information</h2>
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Principal Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="principal" step="0.01" min="1" 
                                           class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="5,000.00" oninput="updatePreview(); calculatePaymentSchedule()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Flat Fee <span class="text-gray-400">(Optional)</span></label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="flatFee" step="0.01" min="0" 
                                           class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="0.00" oninput="updatePreview(); calculatePaymentSchedule()">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">One-time fee charged at origination</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Date</label>
                                <input type="date" id="loanDate" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview(); calculatePaymentSchedule()">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Due Date</label>
                                <input type="date" id="dueDate" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview(); calculatePaymentSchedule()">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Purpose</label>
                            <select id="purpose" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                <option value="">Select purpose...</option>
                                <option value="personal">Personal Expense</option>
                                <option value="medical">Medical Bills</option>
                                <option value="education">Education</option>
                                <option value="business">Business Investment</option>
                                <option value="home">Home Improvement</option>
                                <option value="vehicle">Vehicle Purchase</option>
                                <option value="debt_consolidation">Debt Consolidation</option>
                                <option value="emergency">Emergency Expense</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Schedule</label>
                            <select id="paymentSchedule" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" onchange="updatePreview(); togglePaymentBreakdown(); calculatePaymentSchedule()">
                                <option value="lump_sum">Lump Sum (One Payment)</option>
                                <option value="monthly">Monthly Payments</option>
                                <option value="biweekly">Bi-weekly Payments</option>
                                <option value="weekly">Weekly Payments</option>
                            </select>
                        </div>

                        <!-- Payment Schedule Breakdown -->
                        <div id="paymentBreakdown" class="payment-breakdown p-4 rounded-xl hidden">
                            <h3 class="text-lg font-bold text-blue-900 mb-4 flex items-center gap-2">
                                📊 Payment Schedule Breakdown
                            </h3>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <div class="text-xs text-gray-600">Payment Amount</div>
                                    <div class="text-lg font-bold text-blue-600" id="paymentAmount">$0.00</div>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <div class="text-xs text-gray-600">Number of Payments</div>
                                    <div class="text-lg font-bold text-blue-600" id="numberOfPayments">0</div>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <div class="text-xs text-gray-600">Start Date</div>
                                    <div class="text-sm font-bold text-blue-600" id="startDate">-</div>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <div class="text-xs text-gray-600">End Date</div>
                                    <div class="text-sm font-bold text-blue-600" id="endDate">-</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg overflow-hidden max-h-48 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-blue-600 text-white">
                                        <tr>
                                            <th class="px-3 py-2 text-left">Payment #</th>
                                            <th class="px-3 py-2 text-left">Due Date</th>
                                            <th class="px-3 py-2 text-left">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentScheduleTable">
                                        <!-- Payment rows will be generated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button onclick="nextStep()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors">Continue</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Parties Information -->
                <div id="form-step-2" class="bg-white rounded-xl border border-gray-200 p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Parties Information</h2>
                    
                    <!-- Lender Information (Pre-populated) -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-bold">L</span>
                            Lender Information
                            <span class="text-sm text-green-600 font-normal">(Auto-populated from profile)</span>
                        </h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="lenderFirstName" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="lenderLastName" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" id="lenderEmail" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                                    <input type="tel" id="lenderPhone" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="formatPhone(this); updatePreview()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Address</label>
                                <input type="text" id="lenderAddress" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">City</label>
                                    <input type="text" id="lenderCity" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">State</label>
                                    <select id="lenderState" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview(); updateVenueInfo()">
                                        <option value="">Select State</option>
                                        <option value="AL">Alabama</option>
                                        <option value="AK">Alaska</option>
                                        <option value="AZ">Arizona</option>
                                        <option value="AR">Arkansas</option>
                                        <option value="CA">California</option>
                                        <option value="CO">Colorado</option>
                                        <option value="CT">Connecticut</option>
                                        <option value="DE">Delaware</option>
                                        <option value="FL">Florida</option>
                                        <option value="GA">Georgia</option>
                                        <option value="HI">Hawaii</option>
                                        <option value="ID">Idaho</option>
                                        <option value="IL">Illinois</option>
                                        <option value="IN">Indiana</option>
                                        <option value="IA">Iowa</option>
                                        <option value="KS">Kansas</option>
                                        <option value="KY">Kentucky</option>
                                        <option value="LA">Louisiana</option>
                                        <option value="ME">Maine</option>
                                        <option value="MD">Maryland</option>
                                        <option value="MA">Massachusetts</option>
                                        <option value="MI">Michigan</option>
                                        <option value="MN">Minnesota</option>
                                        <option value="MS">Mississippi</option>
                                        <option value="MO">Missouri</option>
                                        <option value="MT">Montana</option>
                                        <option value="NE">Nebraska</option>
                                        <option value="NV">Nevada</option>
                                        <option value="NH">New Hampshire</option>
                                        <option value="NJ">New Jersey</option>
                                        <option value="NM">New Mexico</option>
                                        <option value="NY">New York</option>
                                        <option value="NC">North Carolina</option>
                                        <option value="ND">North Dakota</option>
                                        <option value="OH">Ohio</option>
                                        <option value="OK">Oklahoma</option>
                                        <option value="OR">Oregon</option>
                                        <option value="PA">Pennsylvania</option>
                                        <option value="RI">Rhode Island</option>
                                        <option value="SC">South Carolina</option>
                                        <option value="SD">South Dakota</option>
                                        <option value="TN">Tennessee</option>
                                        <option value="TX">Texas</option>
                                        <option value="UT">Utah</option>
                                        <option value="VT">Vermont</option>
                                        <option value="VA">Virginia</option>
                                        <option value="WA">Washington</option>
                                        <option value="WV">West Virginia</option>
                                        <option value="WI">Wisconsin</option>
                                        <option value="WY">Wyoming</option>
                                        <option value="DC">District of Columbia</option>
                                        <option value="AS">American Samoa</option>
                                        <option value="GU">Guam</option>
                                        <option value="MP">Northern Mariana Islands</option>
                                        <option value="PR">Puerto Rico</option>
                                        <option value="VI">U.S. Virgin Islands</option>
                                    </select>
                                    <p class="text-xs text-amber-600 mt-1 font-medium">
                                        💡 Keep fees below 10% of principal; suggestion: include contract fee at minimum
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ZIP Code</label>
                                    <input type="text" id="lenderZip" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">County</label>
                                <input type="text" id="lenderCounty" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview(); updateVenueInfo()">
                            </div>
                        </div>
                    </div>

                    <!-- Borrower Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-sm font-bold">B</span>
                            Borrower Information
                        </h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="borrowerFirstName" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="borrowerLastName" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" id="borrowerEmail" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                                    <input type="tel" id="borrowerPhone" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="formatPhone(this); updatePreview()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Address</label>
                                <input type="text" id="borrowerAddress" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">City</label>
                                    <input type="text" id="borrowerCity" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">State</label>
                                    <select id="borrowerState" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                        <option value="">Select State</option>
                                        <option value="AL">Alabama</option>
                                        <option value="AK">Alaska</option>
                                        <option value="AZ">Arizona</option>
                                        <option value="AR">Arkansas</option>
                                        <option value="CA">California</option>
                                        <option value="CO">Colorado</option>
                                        <option value="CT">Connecticut</option>
                                        <option value="DE">Delaware</option>
                                        <option value="FL">Florida</option>
                                        <option value="GA">Georgia</option>
                                        <option value="HI">Hawaii</option>
                                        <option value="ID">Idaho</option>
                                        <option value="IL">Illinois</option>
                                        <option value="IN">Indiana</option>
                                        <option value="IA">Iowa</option>
                                        <option value="KS">Kansas</option>
                                        <option value="KY">Kentucky</option>
                                        <option value="LA">Louisiana</option>
                                        <option value="ME">Maine</option>
                                        <option value="MD">Maryland</option>
                                        <option value="MA">Massachusetts</option>
                                        <option value="MI">Michigan</option>
                                        <option value="MN">Minnesota</option>
                                        <option value="MS">Mississippi</option>
                                        <option value="MO">Missouri</option>
                                        <option value="MT">Montana</option>
                                        <option value="NE">Nebraska</option>
                                        <option value="NV">Nevada</option>
                                        <option value="NH">New Hampshire</option>
                                        <option value="NJ">New Jersey</option>
                                        <option value="NM">New Mexico</option>
                                        <option value="NY">New York</option>
                                        <option value="NC">North Carolina</option>
                                        <option value="ND">North Dakota</option>
                                        <option value="OH">Ohio</option>
                                        <option value="OK">Oklahoma</option>
                                        <option value="OR">Oregon</option>
                                        <option value="PA">Pennsylvania</option>
                                        <option value="RI">Rhode Island</option>
                                        <option value="SC">South Carolina</option>
                                        <option value="SD">South Dakota</option>
                                        <option value="TN">Tennessee</option>
                                        <option value="TX">Texas</option>
                                        <option value="UT">Utah</option>
                                        <option value="VT">Vermont</option>
                                        <option value="VA">Virginia</option>
                                        <option value="WA">Washington</option>
                                        <option value="WV">West Virginia</option>
                                        <option value="WI">Wisconsin</option>
                                        <option value="WY">Wyoming</option>
                                        <option value="DC">District of Columbia</option>
                                        <option value="AS">American Samoa</option>
                                        <option value="GU">Guam</option>
                                        <option value="MP">Northern Mariana Islands</option>
                                        <option value="PR">Puerto Rico</option>
                                        <option value="VI">U.S. Virgin Islands</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ZIP Code</label>
                                    <input type="text" id="borrowerZip" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" oninput="updatePreview()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">SSN (Last 4 digits)</label>
                                <input type="text" id="borrowerSSN" maxlength="4" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="1234" oninput="updatePreview()">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-400 transition-colors">Previous</button>
                        <button onclick="nextStep()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors">Continue</button>
                    </div>
                </div>

                <!-- Step 3: Additional Terms & UCC -->
                <div id="form-step-3" class="bg-white rounded-xl border border-gray-200 p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Legal Terms & Provisions</h2>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Late Fee</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="lateFee" step="0.01" min="0" 
                                           class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="25.00" oninput="updatePreview()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Grace Period (Days)</label>
                                <input type="number" id="gracePeriod" min="0" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       placeholder="10" oninput="updatePreview()">
                            </div>
                        </div>

                        <!-- Legal Warning -->
                        <div class="legal-warning p-4 rounded-xl">
                            <div class="flex items-start gap-3">
                                <div class="text-2xl">⚖️</div>
                                <div>
                                    <h3 class="font-bold text-red-900 mb-2">Small Claims Court Ready</h3>
                                    <p class="text-sm text-red-800">
                                        This promissory note includes provisions designed to meet court enforceability standards. 
                                        All legal clauses comply with UCC Article 3-104 requirements for negotiable instruments.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- UCC Article 9 Section -->
                        <div class="ucc-section p-6 rounded-xl">
                            <div class="flex items-center gap-3 mb-4">
                                <input type="checkbox" id="enableUCC" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="toggleUCCProvisions()">
                                <label for="enableUCC" class="text-lg font-bold text-amber-900">
                                    🛡️ Enable UCC Article 9 Security Interest
                                </label>
                            </div>
                            
                            <p class="text-sm text-amber-800 mb-4">
                                <strong>Recommended:</strong> Include security interest provisions to protect your loan with legal collateral rights under the Uniform Commercial Code. 
                                This gives you additional legal remedies in case of default.
                            </p>

                            <div id="uccProvisions" class="hidden">
                                <div class="bg-white p-4 rounded-lg text-sm text-gray-700 space-y-3">
                                    <div>
                                        <strong class="text-gray-900">SECURITY AGREEMENT:</strong> To secure payment and performance of all obligations under this Promissory Note, Borrower hereby grants to Lender a security interest in and to all of Borrower's right, title, and interest in and to the following collateral (the "Collateral").
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">COLLATERAL DESCRIPTION:</strong> All accounts, chattel paper, commercial tort claims, deposit accounts, documents, equipment, fixtures, general intangibles, goods, instruments, inventory, investment property, letter-of-credit rights, supporting obligations, and proceeds, whether now owned or hereafter acquired by Borrower.
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">PERFECTION:</strong> Borrower authorizes Lender to file such financing statements (UCC-1) and other documents as Lender may deem necessary or appropriate to perfect and maintain the perfection and priority of the security interest granted herein.
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">DEFAULT REMEDIES:</strong> Upon the occurrence of an Event of Default, Lender may exercise all rights and remedies available under the Uniform Commercial Code and other applicable law, including but not limited to: (a) declaring all amounts immediately due and payable; (b) taking possession of Collateral; (c) selling Collateral at public or private sale.
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">ATTORNEY FEES & COSTS:</strong> If Lender employs an attorney to enforce this Note or collect any amount due hereunder, Borrower agrees to pay all reasonable attorney fees, court costs, and collection expenses incurred by Lender.
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">GOVERNING LAW & VENUE:</strong> This Note shall be governed by and construed in accordance with the laws of the State of <span id="venueState" class="font-semibold">[State]</span>. Any legal action arising out of this Note shall be brought exclusively in the courts of <span id="venueCounty" class="font-semibold">[County]</span> County, <span id="venueState2" class="font-semibold">[State]</span>.
                                    </div>
                                    <div>
                                        <strong class="text-gray-900">WAIVER OF JURY TRIAL:</strong> Both parties hereby waive their right to trial by jury in any action or proceeding arising out of or relating to this Note.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-400 transition-colors">Previous</button>
                        <button onclick="nextStep()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors">Review Contract</button>
                    </div>
                </div>

                <!-- Step 4: Review -->
                <div id="form-step-4" class="bg-white rounded-xl border border-gray-200 p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Review Promissory Note</h2>
                    <p class="text-gray-600 mb-6">Please review all details carefully before proceeding to signatures.</p>
                    
                    <!-- Contract Summary Cards -->
                    <div class="space-y-6">
                        <!-- Loan Summary -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-blue-900 mb-4 flex items-center gap-2">
                                💰 Loan Summary
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-blue-700">Principal Amount:</span>
                                    <div class="font-bold text-lg text-blue-900" id="reviewPrincipal">$0.00</div>
                                </div>
                                <div>
                                    <span class="text-blue-700">Flat Fee:</span>
                                    <div class="font-bold text-lg text-blue-900" id="reviewFlatFee">$0.00</div>
                                </div>
                                <div>
                                    <span class="text-blue-700">Total Amount:</span>
                                    <div class="font-bold text-lg text-blue-900" id="reviewTotalAmount">$0.00</div>
                                </div>
                                <div>
                                    <span class="text-blue-700">Payment Schedule:</span>
                                    <div class="font-semibold text-blue-900" id="reviewPaymentSchedule">Lump Sum</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-blue-200">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <span class="text-blue-700">Loan Date:</span>
                                        <div class="font-semibold text-blue-900" id="reviewLoanDate">-</div>
                                    </div>
                                    <div>
                                        <span class="text-blue-700">Due Date:</span>
                                        <div class="font-semibold text-blue-900" id="reviewDueDate">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Parties Information -->
                        <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-green-900 mb-4 flex items-center gap-2">
                                👥 Parties
                            </h3>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <span class="text-green-700 font-semibold">Lender:</span>
                                    <div class="font-bold text-green-900" id="reviewLender">-</div>
                                    <div class="text-sm text-green-700 mt-1" id="reviewLenderEmail">-</div>
                                </div>
                                <div>
                                    <span class="text-green-700 font-semibold">Borrower:</span>
                                    <div class="font-bold text-green-900" id="reviewBorrower">-</div>
                                    <div class="text-sm text-green-700 mt-1" id="reviewBorrowerEmail">-</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-green-200">
                                <span class="text-green-700 font-semibold">Governing Law & Venue:</span>
                                <div class="font-semibold text-green-900" id="reviewVenue">-</div>
                            </div>
                        </div>

                        <!-- Legal Provisions -->
                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-amber-900 mb-4 flex items-center gap-2">
                                ⚖️ Legal Provisions
                            </h3>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="text-amber-700">UCC Article 9:</span>
                                    <div class="font-bold text-amber-900" id="reviewUCC">Not Enabled</div>
                                </div>
                                <div>
                                    <span class="text-amber-700">Late Fee:</span>
                                    <div class="font-bold text-amber-900" id="reviewLateFee">$0.00</div>
                                </div>
                                <div>
                                    <span class="text-amber-700">Grace Period:</span>
                                    <div class="font-bold text-amber-900" id="reviewGracePeriod">0 days</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-amber-200">
                                <div class="flex items-center gap-2 text-amber-800">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="font-semibold">UCC Article 3-104 Compliant</span>
                                </div>
                                <div class="flex items-center gap-2 text-amber-800 mt-1">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="font-semibold">Small Claims Court Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-400 transition-colors">Previous</button>
                        <button onclick="proceedToSigning()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors">Proceed to Signing</button>
                    </div>
                </div>

                <!-- Step 5: Ready to Sign -->
                <div id="form-step-5" class="bg-white rounded-xl border border-gray-200 p-6 text-center hidden">
                    <div class="py-8">
                        <div class="text-6xl mb-6">📝</div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Ready to Sign!</h2>
                        <p class="text-gray-600 mb-8 max-w-md mx-auto">
                            Your legally enforceable promissory note is ready for signatures. Choose your preferred signing method on the next page.
                        </p>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-center gap-2 text-green-800">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-semibold">Court-Enforceable Contract Ready</span>
                            </div>
                        </div>
                        
                        <button onclick="goToSigningPage()" class="bg-blue-600 text-white px-8 py-4 rounded-xl font-semibold hover:bg-blue-700 transition-colors text-lg">
                            Go to Signing Page
                        </button>
                        
                        <p class="text-sm text-gray-500 mt-4">
                            You'll be able to choose between in-person signing or sending a remote invitation.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl border border-gray-200 p-6 sticky top-24">
                    <h3 class="text-lg font-bold text-gray-900 mb-6 text-center">Live Preview</h3>
                    
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="text-sm text-gray-600">Principal Amount</div>
                            <div class="text-2xl font-bold text-blue-600" id="previewPrincipal">$0.00</div>
                        </div>
                        
                        <div id="previewFeeSection" class="text-center hidden">
                            <div class="text-sm text-gray-600">Flat Fee</div>
                            <div class="text-lg font-semibold text-gray-900" id="previewFee">$0.00</div>
                        </div>
                        
                        <div class="text-center border-t pt-4">
                            <div class="text-sm text-gray-600">Total Amount</div>
                            <div class="text-2xl font-bold text-green-600" id="previewTotal">$0.00</div>
                        </div>
                        
                        <div class="border-t pt-4 space-y-3">
                            <div>
                                <div class="text-sm text-gray-600">Purpose</div>
                                <div class="font-semibold" id="previewPurpose">Not specified</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Due Date</div>
                                <div class="font-semibold" id="previewDueDate">Not set</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Payment Schedule</div>
                                <div class="font-semibold" id="previewSchedule">Lump Sum</div>
                            </div>
                        </div>
                        
                        <div id="previewLenderSection" class="border-t pt-4 hidden">
                            <div class="text-sm text-gray-600">Lender</div>
                            <div class="font-semibold" id="previewLender">-</div>
                        </div>
                        
                        <div id="previewBorrowerSection" class="border-t pt-4 hidden">
                            <div class="text-sm text-gray-600">Borrower</div>
                            <div class="font-semibold" id="previewBorrower">-</div>
                        </div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div class="mt-6 pt-4 border-t">
                        <div class="text-sm text-gray-600 mb-2">Progress</div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 20%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Step 1 of 5</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 5;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadLenderInfo();
            updatePreview();
            setTodayAsLoanDate();
        });

        function setTodayAsLoanDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('loanDate').value = today;
        }

        function loadLenderInfo() {
            // Load lender info from localStorage (from profile page)
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            if (profile.firstName) document.getElementById('lenderFirstName').value = profile.firstName;
            if (profile.lastName) document.getElementById('lenderLastName').value = profile.lastName;
            if (profile.email) document.getElementById('lenderEmail').value = profile.email;
            if (profile.phone) document.getElementById('lenderPhone').value = profile.phone;
            if (profile.address) document.getElementById('lenderAddress').value = profile.address;
            if (profile.city) document.getElementById('lenderCity').value = profile.city;
            if (profile.state) document.getElementById('lenderState').value = profile.state;
            if (profile.zip) document.getElementById('lenderZip').value = profile.zip;
            if (profile.county) document.getElementById('lenderCounty').value = profile.county;
            updatePreview();
            updateVenueInfo();
        }

        function togglePaymentBreakdown() {
            const schedule = document.getElementById('paymentSchedule').value;
            const breakdown = document.getElementById('paymentBreakdown');
            
            if (schedule === 'lump_sum') {
                breakdown.classList.add('hidden');
            } else {
                breakdown.classList.remove('hidden');
                calculatePaymentSchedule();
            }
        }

        function calculatePaymentSchedule() {
            const schedule = document.getElementById('paymentSchedule').value;
            if (schedule === 'lump_sum') return;

            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const flatFee = parseFloat(document.getElementById('flatFee').value) || 0;
            const loanDate = new Date(document.getElementById('loanDate').value || Date.now());
            const dueDate = new Date(document.getElementById('dueDate').value || Date.now());
            
            if (principal === 0 || !loanDate || !dueDate) return;
            
            const totalAmount = principal + flatFee;
            const daysDifference = Math.max(1, Math.ceil((dueDate - loanDate) / (1000 * 60 * 60 * 24)));
            
            let numberOfPayments, paymentFrequencyDays;
            
            switch(schedule) {
                case 'monthly':
                    numberOfPayments = Math.max(1, Math.ceil(daysDifference / 30));
                    paymentFrequencyDays = 30;
                    break;
                case 'weekly':
                    numberOfPayments = Math.max(1, Math.ceil(daysDifference / 7));
                    paymentFrequencyDays = 7;
                    break;
                case 'biweekly':
                    numberOfPayments = Math.max(1, Math.ceil(daysDifference / 14));
                    paymentFrequencyDays = 14;
                    break;
                default:
                    return;
            }
            
            const paymentAmount = totalAmount / numberOfPayments;
            
            // Calculate start and end dates
            const startDate = new Date(loanDate);
            startDate.setDate(startDate.getDate() + paymentFrequencyDays);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + (paymentFrequencyDays * (numberOfPayments - 1)));
            
            // Update display
            document.getElementById('paymentAmount').textContent = `$${paymentAmount.toFixed(2)}`;
            document.getElementById('numberOfPayments').textContent = numberOfPayments;
            document.getElementById('startDate').textContent = startDate.toLocaleDateString();
            document.getElementById('endDate').textContent = endDate.toLocaleDateString();
            
            // Generate payment table
            generatePaymentTable(startDate, paymentAmount, numberOfPayments, paymentFrequencyDays);
        }

        function generatePaymentTable(startDate, paymentAmount, numberOfPayments, frequencyDays) {
            const tableBody = document.getElementById('paymentScheduleTable');
            tableBody.innerHTML = '';
            
            let currentDate = new Date(startDate);
            
            for (let i = 1; i <= Math.min(numberOfPayments, 12); i++) { // Show max 12 payments
                const row = document.createElement('tr');
                row.className = i % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                row.innerHTML = `
                    <td class="px-3 py-2">${i}</td>
                    <td class="px-3 py-2">${currentDate.toLocaleDateString()}</td>
                    <td class="px-3 py-2">$${paymentAmount.toFixed(2)}</td>
                `;
                tableBody.appendChild(row);
                
                currentDate = new Date(currentDate.getTime() + (frequencyDays * 24 * 60 * 60 * 1000));
            }
            
            if (numberOfPayments > 12) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="3" class="px-3 py-2 text-center font-style-italic text-gray-600">... and ${numberOfPayments - 12} more payments</td>`;
                tableBody.appendChild(row);
            }
        }

        function toggleUCCProvisions() {
            const enabled = document.getElementById('enableUCC').checked;
            const provisions = document.getElementById('uccProvisions');
            
            if (enabled) {
                provisions.classList.remove('hidden');
                updateVenueInfo();
            } else {
                provisions.classList.add('hidden');
            }
        }

        function updateVenueInfo() {
            const state = document.getElementById('lenderState').value || '[State]';
            const county = document.getElementById('lenderCounty').value || '[County]';
            document.getElementById('venueState').textContent = state;
            document.getElementById('venueState2').textContent = state;
            document.getElementById('venueCounty').textContent = county;
        }

        function nextStep() {
            if (!validateStep(currentStep)) return;
            
            if (currentStep === 4) {
                populateReview();
            }
            
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepDisplay();
                updateProgress();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
                updateProgress();
            }
        }

        function updateStepDisplay() {
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById('form-step-' + i).classList.add('hidden');
                const stepEl = document.getElementById('step-' + i);
                stepEl.classList.remove('step-active', 'step-completed');
                stepEl.classList.add('step-inactive');
            }

            document.getElementById('form-step-' + currentStep).classList.remove('hidden');
            document.getElementById('step-' + currentStep).classList.add('step-active');
            
            for (let i = 1; i < currentStep; i++) {
                document.getElementById('step-' + i).classList.add('step-completed');
            }

            document.getElementById('current-step').textContent = currentStep;

            const labels = ['Loan Details', 'Parties Information', 'Legal Terms', 'Review Contract', 'Ready to Sign'];
            const descriptions = [
                'Enter the basic loan information',
                'Lender and borrower details',
                'Legal provisions and UCC options',
                'Review all contract details',
                'Proceed to signing page'
            ];
            document.getElementById('step-label').textContent = labels[currentStep - 1];
            document.getElementById('step-description').textContent = descriptions[currentStep - 1];

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateProgress() {
            const progressPercentage = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progressPercentage + '%';
        }

        function populateReview() {
            // Loan summary
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const flatFee = parseFloat(document.getElementById('flatFee').value) || 0;
            const lateFee = parseFloat(document.getElementById('lateFee').value) || 0;
            const gracePeriod = parseInt(document.getElementById('gracePeriod').value) || 0;
            
            document.getElementById('reviewPrincipal').textContent = `$${principal.toFixed(2)}`;
            document.getElementById('reviewFlatFee').textContent = `$${flatFee.toFixed(2)}`;
            document.getElementById('reviewTotalAmount').textContent = `$${(principal + flatFee).toFixed(2)}`;
            
            const schedule = document.getElementById('paymentSchedule').options[document.getElementById('paymentSchedule').selectedIndex].text;
            document.getElementById('reviewPaymentSchedule').textContent = schedule;
            document.getElementById('reviewLoanDate').textContent = document.getElementById('loanDate').value ? 
                new Date(document.getElementById('loanDate').value + 'T00:00:00').toLocaleDateString() : '-';
            document.getElementById('reviewDueDate').textContent = document.getElementById('dueDate').value ? 
                new Date(document.getElementById('dueDate').value + 'T00:00:00').toLocaleDateString() : '-';
            
            // Parties
            const lenderName = `${document.getElementById('lenderFirstName').value} ${document.getElementById('lenderLastName').value}`.trim();
            const borrowerName = `${document.getElementById('borrowerFirstName').value} ${document.getElementById('borrowerLastName').value}`.trim();
            const venue = `${document.getElementById('lenderCounty').value || '[County]'} County, ${document.getElementById('lenderState').value || '[State]'}`;
            
            document.getElementById('reviewLender').textContent = lenderName || '-';
            document.getElementById('reviewLenderEmail').textContent = document.getElementById('lenderEmail').value || '-';
            document.getElementById('reviewBorrower').textContent = borrowerName || '-';
            document.getElementById('reviewBorrowerEmail').textContent = document.getElementById('borrowerEmail').value || '-';
            document.getElementById('reviewVenue').textContent = venue;
            
            // Legal provisions
            const uccEnabled = document.getElementById('enableUCC').checked;
            document.getElementById('reviewUCC').textContent = uccEnabled ? 'Enabled' : 'Not Enabled';
            document.getElementById('reviewLateFee').textContent = `$${lateFee.toFixed(2)}`;
            document.getElementById('reviewGracePeriod').textContent = `${gracePeriod} days`;
        }

        function proceedToSigning() {
            // Save contract data to localStorage for signing page
            const contractData = {
                principal: document.getElementById('principal').value,
                flatFee: document.getElementById('flatFee').value,
                loanDate: document.getElementById('loanDate').value,
                dueDate: document.getElementById('dueDate').value,
                purpose: document.getElementById('purpose').value,
                paymentSchedule: document.getElementById('paymentSchedule').value,
                lateFee: document.getElementById('lateFee').value,
                gracePeriod: document.getElementById('gracePeriod').value,
                lender: {
                    firstName: document.getElementById('lenderFirstName').value,
                    lastName: document.getElementById('lenderLastName').value,
                    email: document.getElementById('lenderEmail').value,
                    phone: document.getElementById('lenderPhone').value,
                    address: document.getElementById('lenderAddress').value,
                    city: document.getElementById('lenderCity').value,
                    state: document.getElementById('lenderState').value,
                    zip: document.getElementById('lenderZip').value,
                    county: document.getElementById('lenderCounty').value
                },
                borrower: {
                    firstName: document.getElementById('borrowerFirstName').value,
                    lastName: document.getElementById('borrowerLastName').value,
                    email: document.getElementById('borrowerEmail').value,
                    phone: document.getElementById('borrowerPhone').value,
                    address: document.getElementById('borrowerAddress').value,
                    city: document.getElementById('borrowerCity').value,
                    state: document.getElementById('borrowerState').value,
                    zip: document.getElementById('borrowerZip').value,
                    ssn: document.getElementById('borrowerSSN').value
                },
                uccEnabled: document.getElementById('enableUCC').checked,
                createdDate: new Date().toISOString()
            };
            
            localStorage.setItem('pendingContract', JSON.stringify(contractData));
            nextStep();
        }

        function goToSigningPage() {
            // Redirect to your existing signing page
            window.location.href = 'sign-contract-flexible.html';
        }

        function validateStep(step) {
            if (step === 1) {
                const principal = document.getElementById('principal').value;
                if (!principal || parseFloat(principal) <= 0) {
                    alert('Please enter a valid principal amount');
                    return false;
                }
            } else if (step === 2) {
                const borrowerFirst = document.getElementById('borrowerFirstName').value;
                const borrowerLast = document.getElementById('borrowerLastName').value;
                const borrowerEmail = document.getElementById('borrowerEmail').value;
                if (!borrowerFirst || !borrowerLast) {
                    alert('Please enter borrower name');
                    return false;
                }
                if (!borrowerEmail || !borrowerEmail.includes('@')) {
                    alert('Please enter valid borrower email');
                    return false;
                }
            }
            return true;
        }

        function updatePreview() {
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const fee = parseFloat(document.getElementById('flatFee').value) || 0;
            const total = principal + fee;
            const purpose = document.getElementById('purpose').value;
            const dueDate = document.getElementById('dueDate').value;
            const schedule = document.getElementById('paymentSchedule').options[document.getElementById('paymentSchedule').selectedIndex].text;
            
            document.getElementById('previewPrincipal').textContent = '$' + principal.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('previewTotal').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2});
            
            if (fee > 0) {
                document.getElementById('previewFee').textContent = '$' + fee.toLocaleString('en-US', {minimumFractionDigits: 2});
                document.getElementById('previewFeeSection').classList.remove('hidden');
            } else {
                document.getElementById('previewFeeSection').classList.add('hidden');
            }
            
            document.getElementById('previewPurpose').textContent = purpose ? purpose.charAt(0).toUpperCase() + purpose.slice(1).replace('_', ' ') : 'Not specified';
            document.getElementById('previewDueDate').textContent = dueDate ? new Date(dueDate + 'T00:00:00').toLocaleDateString() : 'Not set';
            document.getElementById('previewSchedule').textContent = schedule;
            
            const lenderFirst = document.getElementById('lenderFirstName').value;
            const lenderLast = document.getElementById('lenderLastName').value;
            const borrowerFirst = document.getElementById('borrowerFirstName').value;
            const borrowerLast = document.getElementById('borrowerLastName').value;
            
            if (lenderFirst && lenderLast) {
                document.getElementById('previewLender').textContent = lenderFirst + ' ' + lenderLast;
                document.getElementById('previewLenderSection').classList.remove('hidden');
            }
            
            if (borrowerFirst && borrowerLast) {
                document.getElementById('previewBorrower').textContent = borrowerFirst + ' ' + borrowerLast;
                document.getElementById('previewBorrowerSection').classList.remove('hidden');
            }
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 10) value = value.slice(0, 10);
            if (value.length >= 6) {
                input.value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6);
            } else if (value.length >= 3) {
                input.value = '(' + value.slice(0, 3) + ') ' + value.slice(3);
            } else {
                input.value = value;
            }
        }

        function saveDraft() {
            const formData = {
                principal: document.getElementById('principal').value,
                flatFee: document.getElementById('flatFee').value,
                loanDate: document.getElementById('loanDate').value,
                dueDate: document.getElementById('dueDate').value,
                purpose: document.getElementById('purpose').value,
                paymentSchedule: document.getElementById('paymentSchedule').value,
                currentStep: currentStep
            };
            localStorage.setItem('trustlend_draft', JSON.stringify(formData));
            alert('Draft saved successfully!');
        }
    </script>
</body>
</html>
