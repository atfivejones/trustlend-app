<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Promissory Note - TrustLend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="mobile-enhancements.css">
    <script src="smart-form-enhancements.js"></script>
    <script src="premium-features.js"></script>
    <style>
        .hero-gradient {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #7c3aed 100%);
        }
        .input-focus:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .step-active {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
        }
        .step-completed {
            background-color: #22c55e;
            color: white;
        }
        .step-inactive {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .preview-document {
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            min-height: 600px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="dashboard.html" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-900">TrustLend</span>
                </a>
                
                <div class="flex items-center space-x-4">
                    <button onclick="saveDraft()" class="text-gray-600 hover:text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Save Draft
                    </button>
                    <a href="dashboard.html" class="text-gray-600 hover:text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div id="step-1" class="step-active flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">
                        1
                    </div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-2" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">
                        2
                    </div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-3" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">
                        3
                    </div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-4" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">
                        4
                    </div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step-5" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">
                        5
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    Step <span id="current-step">1</span> of 5
                </div>
            </div>
            <div class="mt-4">
                <div id="step-label" class="text-lg font-semibold text-gray-900">Loan Details</div>
                <div id="step-description" class="text-sm text-gray-600">Enter the basic loan information</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Form Section -->
            <div class="space-y-6">
                <!-- Step 1: Loan Details -->
                <div id="form-step-1" class="bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Loan Information</h2>
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Principal Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="principal" step="0.01" min="1" max="100000" 
                                           class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="5,000.00" oninput="updatePreview()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Service Fee (Optional)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="serviceFee" step="0.01" min="0" max="1000" 
                                           class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="0.00" oninput="updatePreview()">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">One-time flat fee added to principal (e.g., $50)</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Date</label>
                                <input type="date" id="loanDate" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       oninput="updatePreview()">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Due Date</label>
                                <input type="date" id="dueDate" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       oninput="updatePreview()">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Schedule</label>
                            <select id="paymentSchedule" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" onchange="updatePaymentSchedule()">
                                <option value="lump_sum">Lump Sum Payment</option>
                                <option value="monthly">Monthly Payments</option>
                                <option value="bi_weekly">Bi-Weekly Payments</option>
                                <option value="quarterly">Quarterly Payments</option>
                                <option value="custom">Custom Schedule</option>
                            </select>
                        </div>

                        <!-- Payment Breakdown (shown for non-lump-sum) -->
                        <div id="payment-breakdown" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-900 mb-3">Payment Schedule Breakdown</h4>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Number of Payments</label>
                                    <input type="number" id="numberOfPayments" min="2" max="36" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="6" oninput="calculatePayments()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Amount</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                        <input type="number" id="paymentAmount" step="0.01" readonly
                                               class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl bg-gray-50" 
                                               placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <div id="payment-schedule-table" class="hidden">
                                <div class="bg-white rounded border p-3 max-h-48 overflow-y-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="border-b">
                                                <th class="text-left py-2">Payment #</th>
                                                <th class="text-left py-2">Due Date</th>
                                                <th class="text-right py-2">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payment-schedule-body">
                                            <!-- Generated payment rows -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-2 text-xs text-blue-700">
                                    * Final payment may be adjusted for rounding
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Borrower Information -->
                <div id="form-step-2" class="hidden bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Borrower Information</h2>
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                                <input type="text" id="borrowerFirstName" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       placeholder="John" oninput="updatePreview()">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                                <input type="text" id="borrowerLastName" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       placeholder="Smith" oninput="updatePreview()">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="borrowerEmail" 
                                   class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                   placeholder="john.smith@example.com" oninput="updatePreview()">
                            <p class="text-xs text-gray-500 mt-1">Used for contract delivery and payment reminders</p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="borrowerPhone" 
                                   class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                   placeholder="(555) 123-4567" oninput="updatePreview()">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Address</label>
                            <input type="text" id="borrowerAddress" 
                                   class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                   placeholder="123 Main Street, City, State 12345" oninput="updatePreview()">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Relationship to You</label>
                            <select id="relationship" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" onchange="updatePreview()">
                                <option value="">Select relationship</option>
                                <option value="family">Family Member</option>
                                <option value="friend">Friend</option>
                                <option value="business">Business Associate</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Terms & Conditions -->
                <div id="form-step-3" class="hidden bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Terms & Conditions</h2>
                    <div class="space-y-5">
                        <!-- Late Fee Options -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-900 mb-3">Late Payment Penalties</h3>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="radio" name="lateFeeType" value="none" checked class="text-blue-600" onchange="updatePreview()">
                                    <span class="ml-2 text-gray-700">No late fees</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="lateFeeType" value="flat" class="text-blue-600" onchange="updatePreview()">
                                    <span class="ml-2 text-gray-700">Flat fee: $</span>
                                    <input type="number" id="lateFeeFlat" min="1" max="500" 
                                           class="ml-2 px-2 py-1 border border-gray-300 rounded w-20" 
                                           placeholder="25" oninput="updatePreview()">
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="lateFeeType" value="percentage" class="text-blue-600" onchange="updatePreview()">
                                    <span class="ml-2 text-gray-700">Percentage: </span>
                                    <input type="number" id="lateFeePercent" min="0.1" max="10" step="0.1" 
                                           class="ml-2 px-2 py-1 border border-gray-300 rounded w-20" 
                                           placeholder="5" oninput="updatePreview()">
                                    <span class="ml-1 text-gray-700">% of payment amount</span>
                                </label>
                            </div>
                        </div>

                        <!-- Grace Period -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Grace Period</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="graceDays" min="0" max="30" value="5"
                                       class="input-focus px-4 py-3 border border-gray-300 rounded-xl w-24" 
                                       oninput="updatePreview()">
                                <span class="text-gray-700">days after due date before late fees apply</span>
                            </div>
                        </div>

                        <!-- Acceleration Clause -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <label class="flex items-start">
                                <input type="checkbox" id="accelerationClause" class="text-blue-600 mt-1" onchange="updatePreview()">
                                <div class="ml-3">
                                    <span class="font-semibold text-gray-900">Include Acceleration Clause</span>
                                    <p class="text-sm text-gray-600 mt-1">
                                        If borrower defaults on any payment, the entire remaining balance becomes immediately due and payable.
                                    </p>
                                </div>
                            </label>
                        </div>

                        <!-- Purpose of Loan -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purpose of Loan (Optional)</label>
                            <textarea id="loanPurpose" rows="3" 
                                      class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                      placeholder="e.g., Home improvement, debt consolidation, emergency expenses..."
                                      oninput="updatePreview()"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Security & Verification -->
                <div id="form-step-4" class="hidden bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Security & Verification</h2>
                    <div class="space-y-5">
                        <!-- Collateral -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <label class="flex items-start">
                                <input type="checkbox" id="hasCollateral" class="text-blue-600 mt-1" onchange="toggleCollateral()">
                                <div class="ml-3">
                                    <span class="font-semibold text-gray-900">Secured Loan (with collateral)</span>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Specify property or assets that secure this loan
                                    </p>
                                </div>
                            </label>
                            <div id="collateralDetails" class="hidden mt-4">
                                <textarea id="collateralDescription" rows="3" 
                                          class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                          placeholder="Describe the collateral (e.g., 2018 Honda Civic, VIN: 1HGCM82633A123456)"
                                          oninput="updatePreview()"></textarea>
                            </div>
                        </div>

                        <!-- Guarantor -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <label class="flex items-start">
                                <input type="checkbox" id="hasGuarantor" class="text-blue-600 mt-1" onchange="toggleGuarantor()">
                                <div class="ml-3">
                                    <span class="font-semibold text-gray-900">Add Guarantor/Co-signer</span>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Include a third party who guarantees payment
                                    </p>
                                </div>
                            </label>
                            <div id="guarantorDetails" class="hidden mt-4 space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" id="guarantorName" 
                                           class="input-focus px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="Guarantor Full Name" oninput="updatePreview()">
                                    <input type="email" id="guarantorEmail" 
                                           class="input-focus px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="guarantor@example.com" oninput="updatePreview()">
                                </div>
                            </div>
                        </div>

                        <!-- ID Verification -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-blue-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.031 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                <div class="ml-3">
                                    <h3 class="font-semibold text-blue-900">Identity Verification Required</h3>
                                    <p class="text-sm text-blue-700 mt-1">
                                        Both you and the borrower will be asked to verify your identities using government-issued ID 
                                        during the signing process for maximum security and legal compliance.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Review & Generate -->
                <div id="form-step-5" class="hidden bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Review & Generate Contract</h2>
                    <div class="space-y-5">
                        <!-- Summary -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-900 mb-3">Loan Summary</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Principal Amount:</span>
                                    <span id="summary-principal" class="ml-2 font-semibold">$0.00</span>
                                </div>
                                <div id="summary-fee-section" class="hidden">
                                    <span class="text-gray-600">Service Fee:</span>
                                    <span id="summary-fee" class="ml-2 font-semibold">$0.00</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Borrower:</span>
                                    <span id="summary-borrower" class="ml-2 font-semibold">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Due Date:</span>
                                    <span id="summary-due" class="ml-2 font-semibold">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Blockchain & Security -->
                        <div class="border border-green-200 bg-green-50 rounded-lg p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-green-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.031 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                <div class="ml-3">
                                    <h3 class="font-semibold text-green-900">Blockchain Security Included</h3>
                                    <p class="text-sm text-green-700 mt-1">
                                        Your contract will be timestamped and anchored on the blockchain for immutable proof of existence. 
                                        This creates an unalterable record that strengthens legal enforceability.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Agreement -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <label class="flex items-start">
                                <input type="checkbox" id="finalAgreement" class="text-blue-600 mt-1" required>
                                <div class="ml-3">
                                    <span class="font-semibold text-gray-900">I confirm this information is accurate</span>
                                    <p class="text-sm text-gray-600 mt-1">
                                        I understand this will create a legally binding promissory note. All parties will need to 
                                        sign digitally and verify their identities to complete the contract.
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between items-center pt-6">
                    <button id="prev-btn" onclick="previousStep()" 
                            class="hidden bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                        Previous
                    </button>
                    <div class="flex-1"></div>
                    <button id="next-btn" onclick="nextStep()" 
                            class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all">
                        Next Step
                    </button>
                    <button id="generate-btn" onclick="generateContract()" 
                            class="hidden bg-gradient-to-r from-green-600 to-green-700 text-white px-8 py-3 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Generate Contract
                    </button>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="lg:sticky lg:top-24">
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Live Preview</h3>
                        <button onclick="togglePreview()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                            Toggle Full View
                        </button>
                    </div>
                    
                    <div id="document-preview" class="preview-document p-6 rounded-lg text-sm">
                        <div class="text-center mb-6">
                            <h1 class="text-2xl font-bold text-gray-900 mb-2">PROMISSORY NOTE</h1>
                            <p class="text-gray-600">Legally Binding Loan Agreement</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <strong>Principal Amount:</strong> <span id="preview-principal">$______</span>
                            </div>
                            
                            <div id="preview-service-fee-section" class="hidden">
                                <strong>Service Fee:</strong> <span id="preview-service-fee">$______</span>
                            </div>
                            
                            <div id="preview-total-section" class="hidden">
                                <strong>Total Amount Due:</strong> <span id="preview-total">$______</span>
                            </div>
                            
                            <div>
                                <strong>Borrower:</strong> <span id="preview-borrower">________________</span>
                            </div>
                            
                            <div>
                                <strong>Lender:</strong> <span id="preview-lender">John Doe</span>
                            </div>
                            
                            <div>
                                <strong>Loan Date:</strong> <span id="preview-loan-date">______</span>
                            </div>
                            
                            <div>
                                <strong>Due Date:</strong> <span id="preview-due-date">______</span>
                            </div>
                            
                            <div class="mt-6 p-4 bg-gray-50 rounded">
                                <p class="text-justify leading-relaxed">
                                    FOR VALUE RECEIVED, the undersigned Borrower promises to pay to the order of the Lender 
                                    the principal sum of <span id="preview-principal-text">$______</span><span id="preview-fee-text" class="hidden">, plus a service fee of $____,</span> 
                                    <span id="preview-payment-schedule-text">with the entire amount due and payable on <span id="preview-due-text">______</span></span>.
                                </p>
                            </div>
                            
                            <div id="preview-payment-details" class="hidden mt-4 p-3 bg-white rounded border">
                                <strong>Payment Schedule:</strong>
                                <div id="preview-schedule-summary" class="text-sm mt-2"></div>
                            </div>
                            
                            <div id="preview-late-fees" class="hidden">
                                <strong>Late Fees:</strong> <span id="preview-late-fee-text"></span>
                            </div>
                            
                            <div id="preview-acceleration" class="hidden bg-yellow-50 p-3 rounded">
                                <strong>Acceleration Clause:</strong> Upon default of any payment, the entire unpaid balance shall become immediately due and payable.
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-gray-300">
                                <div class="grid grid-cols-2 gap-8">
                                    <div>
                                        <p class="mb-4">Borrower Signature:</p>
                                        <div class="border-b border-gray-400 h-12"></div>
                                        <p class="text-xs text-gray-600 mt-1">Digital signature required</p>
                                    </div>
                                    <div>
                                        <p class="mb-4">Lender Signature:</p>
                                        <div class="border-b border-gray-400 h-12"></div>
                                        <p class="text-xs text-gray-600 mt-1">Your digital signature</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 text-center">
                                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                    <p class="text-xs text-blue-700">
                                        🔗 Blockchain timestamp will be added upon contract generation
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 5;

        const stepLabels = {
            1: { title: "Loan Details", description: "Enter the basic loan information" },
            2: { title: "Borrower Information", description: "Add borrower contact and personal details" },
            3: { title: "Terms & Conditions", description: "Configure late fees, grace period, and clauses" },
            4: { title: "Security & Verification", description: "Add collateral, guarantors, and security options" },
            5: { title: "Review & Generate", description: "Review all details and create the contract" }
        };

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + 6);
            
            document.getElementById('loanDate').value = today;
            document.getElementById('dueDate').value = futureDate.toISOString().split('T')[0];
            
            updatePreview();
        });

        function nextStep() {
            if (currentStep < totalSteps) {
                if (validateCurrentStep()) {
                    currentStep++;
                    updateStepDisplay();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            // Hide all form steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`form-step-${i}`).classList.add('hidden');
                
                // Update step indicators
                const stepEl = document.getElementById(`step-${i}`);
                stepEl.classList.remove('step-active', 'step-completed');
                stepEl.classList.add('step-inactive');
                
                if (i < currentStep) {
                    stepEl.classList.remove('step-inactive');
                    stepEl.classList.add('step-completed');
                    stepEl.innerHTML = '✓';
                } else if (i === currentStep) {
                    stepEl.classList.remove('step-inactive');
                    stepEl.classList.add('step-active');
                    stepEl.innerHTML = i;
                } else {
                    stepEl.innerHTML = i;
                }
            }

            // Show current step
            document.getElementById(`form-step-${currentStep}`).classList.remove('hidden');
            
            // Update step label and description
            document.getElementById('step-label').textContent = stepLabels[currentStep].title;
            document.getElementById('step-description').textContent = stepLabels[currentStep].description;
            document.getElementById('current-step').textContent = currentStep;

            // Show/hide navigation buttons
            document.getElementById('prev-btn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('next-btn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('generate-btn').classList.toggle('hidden', currentStep !== totalSteps);

            updateSummary();
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    const principal = document.getElementById('principal').value;
                    const loanDate = document.getElementById('loanDate').value;
                    const dueDate = document.getElementById('dueDate').value;
                    
                    if (!principal || parseFloat(principal) <= 0) {
                        alert('Please enter a valid principal amount');
                        return false;
                    }
                    if (!loanDate || !dueDate) {
                        alert('Please select both loan date and due date');
                        return false;
                    }
                    if (new Date(dueDate) <= new Date(loanDate)) {
                        alert('Due date must be after loan date');
                        return false;
                    }
                    
                    // Validate payment schedule if not lump sum
                    const paymentSchedule = document.getElementById('paymentSchedule').value;
                    if (paymentSchedule !== 'lump_sum') {
                        const numberOfPayments = document.getElementById('numberOfPayments').value;
                        if (!numberOfPayments || parseInt(numberOfPayments) < 2) {
                            alert('Please enter at least 2 payments for installment plans');
                            return false;
                        }
                    }
                    break;
                    
                case 2:
                    const borrowerFirst = document.getElementById('borrowerFirstName').value;
                    const borrowerLast = document.getElementById('borrowerLastName').value;
                    const borrowerEmail = document.getElementById('borrowerEmail').value;
                    
                    if (!borrowerFirst || !borrowerLast) {
                        alert('Please enter borrower name');
                        return false;
                    }
                    if (!borrowerEmail || !borrowerEmail.includes('@')) {
                        alert('Please enter a valid email address');
                        return false;
                    }
                    break;
                    
                case 5:
                    const finalAgreement = document.getElementById('finalAgreement').checked;
                    if (!finalAgreement) {
                        alert('Please confirm the information is accurate');
                        return false;
                    }
                    break;
            }
            return true;
        }

        function updatePaymentSchedule() {
            const schedule = document.getElementById('paymentSchedule').value;
            const breakdownDiv = document.getElementById('payment-breakdown');
            
            if (schedule === 'lump_sum') {
                breakdownDiv.classList.add('hidden');
            } else {
                breakdownDiv.classList.remove('hidden');
                
                // Auto-set number of payments based on schedule type
                const numberOfPayments = document.getElementById('numberOfPayments');
                const loanDate = new Date(document.getElementById('loanDate').value);
                const dueDate = new Date(document.getElementById('dueDate').value);
                
                if (loanDate && dueDate) {
                    const monthsDiff = (dueDate.getFullYear() - loanDate.getFullYear()) * 12 + 
                                     (dueDate.getMonth() - loanDate.getMonth());
                    
                    switch(schedule) {
                        case 'monthly':
                            numberOfPayments.value = Math.max(2, monthsDiff);
                            break;
                        case 'bi_weekly':
                            numberOfPayments.value = Math.max(2, Math.floor(monthsDiff * 2.2)); // ~2.2 bi-weekly periods per month
                            break;
                        case 'quarterly':
                            numberOfPayments.value = Math.max(2, Math.floor(monthsDiff / 3));
                            break;
                        case 'custom':
                            numberOfPayments.value = 6; // Default
                            break;
                    }
                    
                    calculatePayments();
                }
            }
            
            updatePreview();
        }

        function calculatePayments() {
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
            const totalAmount = principal + serviceFee;
            const numberOfPayments = parseInt(document.getElementById('numberOfPayments').value) || 1;
            
            if (totalAmount <= 0 || numberOfPayments <= 0) {
                document.getElementById('paymentAmount').value = '';
                document.getElementById('payment-schedule-table').classList.add('hidden');
                return;
            }
            
            const paymentAmount = totalAmount / numberOfPayments;
            document.getElementById('paymentAmount').value = paymentAmount.toFixed(2);
            
            generatePaymentScheduleTable();
            updatePreview();
        }

        function generatePaymentScheduleTable() {
            const schedule = document.getElementById('paymentSchedule').value;
            const numberOfPayments = parseInt(document.getElementById('numberOfPayments').value) || 1;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const loanDate = new Date(document.getElementById('loanDate').value);
            
            if (!loanDate || numberOfPayments <= 0 || paymentAmount <= 0) {
                document.getElementById('payment-schedule-table').classList.add('hidden');
                return;
            }
            
            const tbody = document.getElementById('payment-schedule-body');
            tbody.innerHTML = '';
            
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
            const totalAmount = principal + serviceFee;
            
            let runningTotal = 0;
            
            for (let i = 1; i <= numberOfPayments; i++) {
                const paymentDate = new Date(loanDate);
                
                // Calculate payment date based on schedule
                switch(schedule) {
                    case 'monthly':
                        paymentDate.setMonth(paymentDate.getMonth() + i);
                        break;
                    case 'bi_weekly':
                        paymentDate.setDate(paymentDate.getDate() + (i * 14));
                        break;
                    case 'quarterly':
                        paymentDate.setMonth(paymentDate.getMonth() + (i * 3));
                        break;
                    case 'custom':
                        // For custom, distribute evenly across the loan period
                        const dueDate = new Date(document.getElementById('dueDate').value);
                        const totalDays = (dueDate - loanDate) / (1000 * 60 * 60 * 24);
                        const daysBetweenPayments = totalDays / numberOfPayments;
                        paymentDate.setDate(paymentDate.getDate() + (i * daysBetweenPayments));
                        break;
                }
                
                // Calculate this payment amount (adjust final payment for rounding)
                let thisPaymentAmount = paymentAmount;
                runningTotal += paymentAmount;
                
                if (i === numberOfPayments) {
                    // Adjust final payment to ensure total equals exactly the loan amount
                    const difference = totalAmount - (runningTotal - paymentAmount);
                    thisPaymentAmount = difference;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-1">${i}</td>
                    <td class="py-1">${paymentDate.toLocaleDateString()}</td>
                    <td class="py-1 text-right">$${thisPaymentAmount.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            }
            
            document.getElementById('payment-schedule-table').classList.remove('hidden');
        }

        function updatePreview() {
            const principal = document.getElementById('principal').value || 0;
            const serviceFee = document.getElementById('serviceFee').value || 0;
            const borrowerFirst = document.getElementById('borrowerFirstName').value;
            const borrowerLast = document.getElementById('borrowerLastName').value;
            const loanDate = document.getElementById('loanDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const paymentSchedule = document.getElementById('paymentSchedule').value;

            // Update preview fields
            const formattedPrincipal = principal ? `$${parseFloat(principal).toLocaleString('en-US', {minimumFractionDigits: 2})}` : '$______';
            document.getElementById('preview-principal').textContent = formattedPrincipal;
            document.getElementById('preview-principal-text').textContent = formattedPrincipal;
            
            // Handle service fee
            const serviceFeeSection = document.getElementById('preview-service-fee-section');
            const totalSection = document.getElementById('preview-total-section');
            const feeText = document.getElementById('preview-fee-text');
            
            if (serviceFee && parseFloat(serviceFee) > 0) {
                const formattedFee = `$${parseFloat(serviceFee).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                const totalAmount = parseFloat(principal || 0) + parseFloat(serviceFee);
                const formattedTotal = `$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                
                document.getElementById('preview-service-fee').textContent = formattedFee;
                document.getElementById('preview-total').textContent = formattedTotal;
                serviceFeeSection.classList.remove('hidden');
                totalSection.classList.remove('hidden');
                feeText.classList.remove('hidden');
                feeText.innerHTML = `, plus a service fee of ${formattedFee},`;
            } else {
                serviceFeeSection.classList.add('hidden');
                totalSection.classList.add('hidden');
                feeText.classList.add('hidden');
            }
            
            const borrowerName = borrowerFirst && borrowerLast ? `${borrowerFirst} ${borrowerLast}` : '________________';
            document.getElementById('preview-borrower').textContent = borrowerName;
            
            document.getElementById('preview-loan-date').textContent = loanDate ? new Date(loanDate).toLocaleDateString() : '______';
            document.getElementById('preview-due-date').textContent = dueDate ? new Date(dueDate).toLocaleDateString() : '______';
            document.getElementById('preview-due-text').textContent = dueDate ? new Date(dueDate).toLocaleDateString() : '______';

            // Update payment schedule in preview
            const paymentScheduleText = document.getElementById('preview-payment-schedule-text');
            const paymentDetailsDiv = document.getElementById('preview-payment-details');
            const scheduleSummary = document.getElementById('preview-schedule-summary');
            
            if (paymentSchedule === 'lump_sum') {
                paymentScheduleText.innerHTML = `with the entire amount due and payable on <span id="preview-due-text">${dueDate ? new Date(dueDate).toLocaleDateString() : '______'}</span>`;
                paymentDetailsDiv.classList.add('hidden');
            } else {
                const numberOfPayments = document.getElementById('numberOfPayments').value;
                const paymentAmount = document.getElementById('paymentAmount').value;
                
                if (numberOfPayments && paymentAmount) {
                    const scheduleNames = {
                        'monthly': 'monthly',
                        'bi_weekly': 'bi-weekly', 
                        'quarterly': 'quarterly',
                        'custom': 'custom'
                    };
                    
                    paymentScheduleText.innerHTML = `in ${numberOfPayments} ${scheduleNames[paymentSchedule]} payments of $${parseFloat(paymentAmount).toFixed(2)} each, with final payment due on <span class="preview-due-text">${dueDate ? new Date(dueDate).toLocaleDateString() : '______'}</span>`;
                    
                    scheduleSummary.innerHTML = `${numberOfPayments} payments of $${parseFloat(paymentAmount).toFixed(2)} = $${(numberOfPayments * parseFloat(paymentAmount)).toFixed(2)} total`;
                    paymentDetailsDiv.classList.remove('hidden');
                } else {
                    paymentScheduleText.innerHTML = `in installments as specified in the payment schedule, with final payment due on <span class="preview-due-text">${dueDate ? new Date(dueDate).toLocaleDateString() : '______'}</span>`;
                    paymentDetailsDiv.classList.add('hidden');
                }
            }

            // Update late fees
            const lateFeeType = document.querySelector('input[name="lateFeeType"]:checked')?.value;
            const lateFeeSection = document.getElementById('preview-late-fees');
            
            if (lateFeeType === 'flat') {
                const flatFee = document.getElementById('lateFeeFlat').value;
                if (flatFee) {
                    lateFeeSection.classList.remove('hidden');
                    document.getElementById('preview-late-fee-text').textContent = `$${flatFee} flat fee for late payments`;
                }
            } else if (lateFeeType === 'percentage') {
                const percentFee = document.getElementById('lateFeePercent').value;
                if (percentFee) {
                    lateFeeSection.classList.remove('hidden');
                    document.getElementById('preview-late-fee-text').textContent = `${percentFee}% of payment amount for late payments`;
                }
            } else {
                lateFeeSection.classList.add('hidden');
            }

            // Update acceleration clause
            const acceleration = document.getElementById('accelerationClause')?.checked;
            document.getElementById('preview-acceleration').classList.toggle('hidden', !acceleration);
        }
            document.getElementById('preview-borrower').textContent = borrowerName;
            
            document.getElementById('preview-loan-date').textContent = loanDate ? new Date(loanDate).toLocaleDateString() : '______';
            document.getElementById('preview-due-date').textContent = dueDate ? new Date(dueDate).toLocaleDateString() : '______';
            document.getElementById('preview-due-text').textContent = dueDate ? new Date(dueDate).toLocaleDateString() : '______';

            // Update late fees
            const lateFeeType = document.querySelector('input[name="lateFeeType"]:checked')?.value;
            const lateFeeSection = document.getElementById('preview-late-fees');
            
            if (lateFeeType === 'flat') {
                const flatFee = document.getElementById('lateFeeFlat').value;
                if (flatFee) {
                    lateFeeSection.classList.remove('hidden');
                    document.getElementById('preview-late-fee-text').textContent = `$${flatFee} flat fee for late payments`;
                }
            } else if (lateFeeType === 'percentage') {
                const percentFee = document.getElementById('lateFeePercent').value;
                if (percentFee) {
                    lateFeeSection.classList.remove('hidden');
                    document.getElementById('preview-late-fee-text').textContent = `${percentFee}% of payment amount for late payments`;
                }
            } else {
                lateFeeSection.classList.add('hidden');
            }

            // Update acceleration clause
            const acceleration = document.getElementById('accelerationClause')?.checked;
            document.getElementById('preview-acceleration').classList.toggle('hidden', !acceleration);
        }

        function updateSummary() {
            if (currentStep === 5) {
                const principal = document.getElementById('principal').value;
                const serviceFee = document.getElementById('serviceFee').value || 0;
                const borrowerFirst = document.getElementById('borrowerFirstName').value;
                const borrowerLast = document.getElementById('borrowerLastName').value;
                const dueDate = document.getElementById('dueDate').value;

                document.getElementById('summary-principal').textContent = principal ? `$${parseFloat(principal).toLocaleString()}` : '$0.00';
                
                // Handle service fee in summary
                const summaryFeeSection = document.getElementById('summary-fee-section');
                if (serviceFee && parseFloat(serviceFee) > 0) {
                    document.getElementById('summary-fee').textContent = `$${parseFloat(serviceFee).toLocaleString()}`;
                    summaryFeeSection.classList.remove('hidden');
                } else {
                    summaryFeeSection.classList.add('hidden');
                }
                
                document.getElementById('summary-borrower').textContent = borrowerFirst && borrowerLast ? `${borrowerFirst} ${borrowerLast}` : '-';
                document.getElementById('summary-due').textContent = dueDate ? new Date(dueDate).toLocaleDateString() : '-';
            }
        }

        function toggleCollateral() {
            const checkbox = document.getElementById('hasCollateral');
            const details = document.getElementById('collateralDetails');
            details.classList.toggle('hidden', !checkbox.checked);
        }

        function toggleGuarantor() {
            const checkbox = document.getElementById('hasGuarantor');
            const details = document.getElementById('guarantorDetails');
            details.classList.toggle('hidden', !checkbox.checked);
        }

        function togglePreview() {
            const preview = document.getElementById('document-preview');
            preview.classList.toggle('fixed');
            preview.classList.toggle('inset-0');
            preview.classList.toggle('z-50');
            preview.classList.toggle('bg-white');
            preview.classList.toggle('overflow-auto');
        }

        function saveDraft() {
            const formData = gatherFormData();
            localStorage.setItem('trustlend_draft', JSON.stringify(formData));
            alert('Draft saved! You can continue editing later.');
        }

        function gatherFormData() {
            return {
                principal: document.getElementById('principal').value,
                serviceFee: document.getElementById('serviceFee').value,
                loanDate: document.getElementById('loanDate').value,
                dueDate: document.getElementById('dueDate').value,
                paymentSchedule: document.getElementById('paymentSchedule').value,
                numberOfPayments: document.getElementById('numberOfPayments').value,
                paymentAmount: document.getElementById('paymentAmount').value,
                borrowerFirstName: document.getElementById('borrowerFirstName').value,
                borrowerLastName: document.getElementById('borrowerLastName').value,
                borrowerEmail: document.getElementById('borrowerEmail').value,
                borrowerPhone: document.getElementById('borrowerPhone').value,
                borrowerAddress: document.getElementById('borrowerAddress').value,
                relationship: document.getElementById('relationship').value,
                lateFeeType: document.querySelector('input[name="lateFeeType"]:checked')?.value,
                lateFeeFlat: document.getElementById('lateFeeFlat').value,
                lateFeePercent: document.getElementById('lateFeePercent').value,
                graceDays: document.getElementById('graceDays').value,
                accelerationClause: document.getElementById('accelerationClause')?.checked,
                loanPurpose: document.getElementById('loanPurpose').value,
                hasCollateral: document.getElementById('hasCollateral')?.checked,
                collateralDescription: document.getElementById('collateralDescription').value,
                hasGuarantor: document.getElementById('hasGuarantor')?.checked,
                guarantorName: document.getElementById('guarantorName').value,
                guarantorEmail: document.getElementById('guarantorEmail').value,
                currentStep: currentStep
            };
        }

        function generateContract() {
            if (!validateCurrentStep()) return;
            
            const formData = gatherFormData();
            
            // Simulate contract generation
            alert(`🎉 Contract Generated Successfully!\n\nNext steps:\n1. Both parties will receive signing invitations\n2. ID verification will be required\n3. Digital signatures will be captured\n4. Blockchain timestamp will be added\n5. Final PDF bundle will be created\n\nContract ID: TL-${Date.now()}`);
            
            // In production, this would:
            // 1. Send data to backend for PDF generation
            // 2. Create signing workflow
            // 3. Send invitations to parties
            // 4. Return to dashboard with new contract
            
            console.log('Contract data:', formData);
            window.location.href = 'dashboard.html';
        }

        // Auto-save functionality
        setInterval(() => {
            if (currentStep > 1) {
                saveDraft();
            }
        }, 60000); // Save every minute
    </script>
</body>
</html>