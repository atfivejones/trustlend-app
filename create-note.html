<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Promissory Note - TrustLend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Stripe Payment Integration -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- TrustLend Assets -->
    <link rel="stylesheet" href="css/mobile-enhancements.css">
    <script src="js/smart-form-enhancements.js"></script>
    <script src="js/premium-features.js"></script>
    <script src="js/promissory-note-generator.js"></script>
    
    <style>
        .input-focus:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .step-active {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
        }
        .step-completed {
            background-color: #22c55e;
            color: white;
        }
        .step-inactive {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .pricing-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .pricing-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .pricing-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
        }
        .feature-included {
            color: #22c55e;
        }
        .feature-excluded {
            color: #6b7280;
        }
        .billing-step {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }
        .payment-processing {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- TrustLend Universal Navigation -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-900">TrustLend</span>
                </a>
                
                <button id="mobileMenuBtn" class="md:hidden flex items-center justify-center w-10 h-10 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

                <div id="desktopNav" class="hidden md:flex items-center space-x-4">
                    <div id="authenticatedNav" class="flex items-center space-x-4">
                        <button onclick="saveDraft()" class="text-gray-600 hover:text-gray-900 flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Save Draft
                        </button>
                        
                        <a href="dashboard.html" class="text-gray-600 hover:text-gray-900 flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                            Dashboard
                        </a>

                        <div class="relative group">
                            <button class="flex items-center text-gray-600 hover:text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                    <span id="userInitials" class="text-sm font-semibold text-blue-600">TU</span>
                                </div>
                                <span class="hidden lg:inline" id="userName">Account</span>
                                <div class="w-2 h-2 bg-green-500 rounded-full ml-1" title="Blockchain Verified"></div>
                                <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            
                            <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                                <div class="py-2">
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <div id="userEmail" class="text-sm text-gray-900 font-medium">user@example.com</div>
                                        <div class="text-xs text-blue-600 flex items-center mt-1">
                                            üîó Blockchain Verified ‚Ä¢ <span id="userPlan">Essential Plan</span>
                                        </div>
                                    </div>
                                    <a href="profile.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        Profile Settings
                                    </a>
                                    <a href="billing.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                        </svg>
                                        Billing & Plans
                                    </a>
                                    <a href="audit-trail.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Audit Trail & Verification
                                    </a>
                                    <a href="support.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Help & Support
                                    </a>
                                    <hr class="my-1">
                                    <button onclick="signOut()" class="flex items-center w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div id="step-1" class="step-active flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">1</div>
                    <div class="w-12 h-1 bg-gray-300"></div>
                    <div id="step-2" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">2</div>
                    <div class="w-12 h-1 bg-gray-300"></div>
                    <div id="step-3" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">3</div>
                    <div class="w-12 h-1 bg-gray-300"></div>
                    <div id="step-4" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">üí≥</div>
                    <div class="w-12 h-1 bg-gray-300"></div>
                    <div id="step-5" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">‚úèÔ∏è</div>
                    <div class="w-12 h-1 bg-gray-300"></div>
                    <div id="step-6" class="step-inactive flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm transition-all">‚úÖ</div>
                </div>
                <div class="text-sm text-gray-600">Step <span id="current-step">1</span> of 6</div>
            </div>
            <div class="mt-4">
                <div id="step-label" class="text-lg font-semibold text-gray-900">Loan Details</div>
                <div id="step-description" class="text-sm text-gray-600">Enter the basic loan information</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Form Section -->
            <div class="space-y-6">
                <!-- Step 1: Loan Details -->
                <div id="form-step-1" class="bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Loan Information</h2>
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Principal Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="principal" step="0.01" min="1" 
                                           class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="5,000.00" oninput="updatePreview(); calculatePaymentSchedule()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Flat Fee (Optional)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="flatFee" step="0.01" min="0" 
                                           class="input-focus w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="0.00" oninput="updatePreview(); calculatePaymentSchedule()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Date</label>
                                <input type="date" id="loanDate" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       oninput="updatePreview()">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Due Date</label>
                                <input type="date" id="dueDate" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       oninput="updatePreview(); calculatePaymentSchedule()">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Purpose</label>
                            <input type="text" id="purpose" 
                                   class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                   placeholder="e.g., Personal expenses, education, vehicle repair"
                                   oninput="updatePreview()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Schedule</label>
                            <select id="paymentSchedule" 
                                    class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                    onchange="togglePaymentBreakdown(); updatePreview()">
                                <option value="lump_sum">Lump Sum Payment</option>
                                <option value="monthly">Monthly Payments</option>
                                <option value="weekly">Weekly Payments</option>
                                <option value="biweekly">Bi-weekly Payments</option>
                            </select>
                        </div>
                        
                        <!-- Late Fee Options -->
                        <div class="border-t pt-4 mt-6">
                            <label class="flex items-center mb-4">
                                <input type="checkbox" id="enableLateFee" class="mr-3 w-4 h-4 text-blue-600" onchange="toggleLateFeeOptions()">
                                <span class="text-sm font-semibold text-gray-700">Enable Late Fees</span>
                            </label>
                            
                            <div id="lateFeeOptions" class="hidden space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Late Fee Type</label>
                                        <select id="lateFeeType" class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl">
                                            <option value="flat">Flat Amount</option>
                                            <option value="percentage">Percentage</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Amount/Percentage</label>
                                        <input type="number" id="lateFeeAmount" step="0.01" min="0" 
                                               class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                               placeholder="25.00">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Grace Period (Days)</label>
                                    <input type="number" id="graceDays" min="0" max="30" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="15" value="15">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Party Information -->
                <div id="form-step-2" class="bg-white rounded-xl border border-gray-200 p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Party Information</h2>
                    
                    <!-- Lender Information -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Lender Information (You)</h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-blue-800">
                                <span class="font-semibold">Auto-filled:</span> Information below is automatically populated from your profile.
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="lenderFirstName" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="Your first name" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="lenderLastName" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="Your last name" oninput="updatePreview()">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" id="lenderEmail" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                                    <input type="tel" id="lenderPhone" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="(555) 123-4567" oninput="formatPhoneNumber(this)">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Borrower Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Borrower Information</h3>
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-amber-800">
                                <span class="font-semibold">Identity Verification:</span> SSN and DOB help verify borrower identity for legal compliance.
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="borrowerFirstName" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="Borrower's first name" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="borrowerLastName" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="Borrower's last name" oninput="updatePreview()">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" id="borrowerEmail" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="borrower@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                                    <input type="tel" id="borrowerPhone" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="(555) 123-4567" oninput="formatPhoneNumber(this)">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last 4 Digits of SSN</label>
                                    <input type="text" id="borrowerSSN" maxlength="4" pattern="[0-9]{4}"
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                           placeholder="1234" oninput="formatSSN(this)">
                                    <p class="text-xs text-gray-500 mt-1">For verification purposes only</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth</label>
                                    <input type="date" id="borrowerDOB" 
                                           class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl">
                                    <p class="text-xs text-gray-500 mt-1">Optional - for additional verification</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review -->
                <div id="form-step-3" class="bg-white rounded-xl border border-gray-200 p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Review Contract</h2>
                    <p class="text-gray-600 mb-6">Please review all details carefully before proceeding to billing.</p>
                    
                    <div id="contractReview" class="space-y-4 bg-gray-50 p-6 rounded-xl">
                        <!-- Contract details will be populated here -->
                    </div>
                    
                    <!-- Legal Disclaimers -->
                    <div class="mt-6 space-y-4">
                        <label class="flex items-start">
                            <input type="checkbox" id="agreedToTerms" class="mr-3 mt-1 w-4 h-4 text-blue-600">
                            <span class="text-sm text-gray-700">
                                I understand that this is a legally binding promissory note and I have reviewed all terms carefully.
                            </span>
                        </label>
                        
                        <label class="flex items-start">
                            <input type="checkbox" id="agreedToEsign" class="mr-3 mt-1 w-4 h-4 text-blue-600">
                            <span class="text-sm text-gray-700">
                                I agree to use electronic signatures for this document and understand they are legally equivalent to handwritten signatures.
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Step 4: Billing Tier Selection -->
                <div id="form-step-4" class="billing-step rounded-xl border border-gray-200 p-6 hidden">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">Choose Your Package</h2>
                        <p class="text-lg text-gray-600">Select the features you need for this promissory note</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <!-- Basic Plan -->
                        <div id="basic-plan" class="pricing-card bg-white border-2 border-gray-200 rounded-xl p-6" onclick="selectPlan('basic')">
                            <div class="text-center mb-6">
                                <div class="text-2xl font-bold text-gray-900 mb-2">Basic</div>
                                <div class="text-4xl font-bold text-blue-600 mb-2">$19</div>
                                <div class="text-sm text-gray-600">Perfect for simple loans</div>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">Legally binding promissory note</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">Basic electronic signatures</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">Email delivery to both parties</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">PDF download</span>
                                </div>
                                <div class="flex items-center feature-excluded">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">Blockchain verification</span>
                                </div>
                                <div class="flex items-center feature-excluded">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">Advanced audit trail</span>
                                </div>
                                <div class="flex items-center feature-excluded">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">SMS signature requests</span>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="button" class="basic-select-btn w-full py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                    Select Basic
                                </button>
                            </div>
                        </div>
                        
                        <!-- Enhanced Plan -->
                        <div id="enhanced-plan" class="pricing-card bg-white border-2 border-blue-500 rounded-xl p-6 relative" onclick="selectPlan('enhanced')">
                            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                <div class="bg-blue-500 text-white px-4 py-1 rounded-full text-xs font-semibold">RECOMMENDED</div>
                            </div>
                            
                            <div class="text-center mb-6">
                                <div class="text-2xl font-bold text-gray-900 mb-2">Enhanced</div>
                                <div class="text-4xl font-bold text-blue-600 mb-2">$39</div>
                                <div class="text-sm text-gray-600">Full blockchain verification</div>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm font-semibold">Everything in Basic, plus:</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">üîó Blockchain verification</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">üìä Complete audit trail</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">üì± SMS signature requests with OTP</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">üèõÔ∏è UCC Article 9 compliance</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">‚úèÔ∏è Advanced signature options</span>
                                </div>
                                <div class="flex items-center feature-included">
                                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm">üîí Document encryption & tamper protection</span>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="button" class="enhanced-select-btn w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    Select Enhanced
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Summary -->
                    <div id="payment-summary" class="bg-white border border-gray-200 rounded-xl p-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Summary</h3>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-700">Selected Plan:</span>
                            <span id="selected-plan-name" class="font-semibold text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-700">Price:</span>
                            <span id="selected-plan-price" class="font-semibold text-gray-900">$0</span>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center text-lg font-bold">
                                <span>Total:</span>
                                <span id="total-amount" class="text-blue-600">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Payment Processing -->
                <div id="form-step-5" class="payment-processing rounded-xl border border-gray-200 p-6 hidden">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Complete Payment</h2>
                        <p class="text-gray-600">Secure payment to generate and deliver your promissory note</p>
                    </div>
                    
                    <!-- Payment Method Selection -->
                    <div class="bg-white rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Method</h3>
                        
                        <div class="space-y-4">
                            <!-- Credit/Debit Card -->
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="paymentMethod" value="card" class="mr-4 w-4 h-4 text-blue-600" checked>
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                    <div>
                                        <div class="font-semibold text-gray-900">Credit/Debit Card</div>
                                        <div class="text-sm text-gray-600">Visa, Mastercard, American Express</div>
                                    </div>
                                </div>
                            </label>
                            
                            <!-- PayPal -->
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="paymentMethod" value="paypal" class="mr-4 w-4 h-4 text-blue-600">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-3 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.26-.98 5.24-4.509 7.105-8.981 7.105h-2.02c-.524 0-.968.382-1.05.9L6.19 21.337h3.885c.448 0 .828-.329.897-.329l.013-.013.357-2.26c.082-.518.526-.9 1.05-.9h.896c3.676 0 6.554-1.495 7.378-5.813.343-1.798.134-3.302-.934-4.405z"/>
                                    </svg>
                                    <div>
                                        <div class="font-semibold text-gray-900">PayPal</div>
                                        <div class="text-sm text-gray-600">Pay with your PayPal account</div>
                                    </div>
                                </div>
                            </label>
                            
                            <!-- Manual/In-Person -->
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="paymentMethod" value="manual" class="mr-4 w-4 h-4 text-blue-600">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v2a2 2 0 002 2z"></path>
                                    </svg>
                                    <div>
                                        <div class="font-semibold text-gray-900">Manual Payment / In-Person</div>
                                        <div class="text-sm text-gray-600">Pay cash or check in person, then download</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Credit Card Form -->
                    <div id="card-payment-form" class="bg-white rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Card Information</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Card Number</label>
                                <div id="card-number-element" class="px-4 py-3 border border-gray-300 rounded-xl">
                                    <!-- Stripe Element will be inserted here -->
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Expiry Date</label>
                                    <div id="card-expiry-element" class="px-4 py-3 border border-gray-300 rounded-xl">
                                        <!-- Stripe Element will be inserted here -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">CVC</label>
                                    <div id="card-cvc-element" class="px-4 py-3 border border-gray-300 rounded-xl">
                                        <!-- Stripe Element will be inserted here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cardholder Name</label>
                                <input type="text" id="cardholder-name" 
                                       class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl" 
                                       placeholder="Name on card">
                            </div>
                        </div>
                        
                        <div id="card-errors" class="text-red-600 text-sm mt-2 hidden"></div>
                    </div>
                    
                    <!-- PayPal Section -->
                    <div id="paypal-payment-form" class="bg-white rounded-xl p-6 mb-6 hidden">
                        <div class="text-center py-8">
                            <div class="text-4xl mb-4">üí≥</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">PayPal Payment</h3>
                            <p class="text-gray-600 mb-6">You'll be redirected to PayPal to complete your payment securely.</p>
                            <div id="paypal-button-container" class="max-w-md mx-auto">
                                <!-- PayPal button will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Payment Section -->
                    <div id="manual-payment-form" class="bg-white rounded-xl p-6 mb-6 hidden">
                        <div class="text-center py-8">
                            <div class="text-4xl mb-4">ü§ù</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Manual Payment</h3>
                            <p class="text-gray-600 mb-6">
                                After completing payment in person, click "Mark as Paid" below to access your contract.
                            </p>
                            
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center justify-center gap-2 text-amber-800 mb-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <strong>Payment Information</strong>
                                </div>
                                <div class="text-sm text-amber-800">
                                    Amount Due: <strong id="manual-amount">$0</strong><br>
                                    Payment Method: Cash, Check, or Bank Transfer<br>
                                    Reference: Contract #<span id="contract-reference">TC-001</span>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <label class="flex items-center justify-center">
                                    <input type="checkbox" id="payment-confirmed" class="mr-3 w-4 h-4 text-blue-600">
                                    <span class="text-sm text-gray-700">I confirm that payment has been received</span>
                                </label>
                                
                                <button id="mark-paid-btn" onclick="markAsPaid()" disabled
                                        class="w-full px-6 py-3 bg-gray-400 text-white rounded-lg cursor-not-allowed">
                                    Mark as Paid & Continue
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Summary for Step 5 -->
                    <div class="bg-white border border-gray-200 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Order Summary</h3>
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between">
                                <span class="text-gray-700">Plan:</span>
                                <span id="payment-plan-name" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Contract for:</span>
                                <span id="payment-borrower-name" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Amount:</span>
                                <span id="payment-loan-amount" class="font-semibold">-</span>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center text-lg font-bold">
                                <span>Total Due:</span>
                                <span id="payment-total" class="text-blue-600">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Signatures & Completion -->
                <div id="form-step-6" class="bg-white rounded-xl border border-gray-200 p-6 hidden">
                    <div class="text-center py-8">
                        <div class="text-6xl mb-6">‚úÖ</div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Payment Successful!</h2>
                        <p class="text-gray-600 mb-8 max-w-md mx-auto">
                            Your contract is now ready for signatures. Both parties will receive signing instructions via email.
                        </p>
                        
                        <!-- Contract Actions -->
                        <div class="space-y-4 max-w-md mx-auto">
                            <button onclick="downloadContract()" 
                                    class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Contract PDF
                            </button>
                            
                            <button onclick="sendSignatureRequests()" 
                                    class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Send for E-Signatures
                            </button>
                            
                            <button onclick="viewAuditTrail()" 
                                    class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                View Blockchain Audit Trail
                            </button>
                            
                            <a href="dashboard.html" 
                               class="block w-full px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-center">
                                Return to Dashboard
                            </a>
                        </div>
                        
                        <!-- Enhanced Features Display -->
                        <div id="enhanced-features-display" class="hidden mt-8 bg-green-50 border border-green-200 rounded-xl p-6">
                            <h3 class="font-semibold text-green-900 mb-3">üîó Enhanced Features Active</h3>
                            <div class="text-sm text-green-800 space-y-2">
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span><strong>Blockchain verification</strong> enabled</span>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span><strong>Advanced audit trail</strong> recording</span>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span><strong>SMS/OTP verification</strong> available</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between">
                    <button id="prevBtn" onclick="prevStep()" 
                            class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 hidden">
                        Previous
                    </button>
                    <div class="flex-1"></div>
                    <button id="nextBtn" onclick="nextStep()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Next
                    </button>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl border border-gray-200 p-6 sticky top-8">
                    <h3 class="text-lg font-bold text-gray-900 mb-6">Contract Preview</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Loan Amount</div>
                            <div class="text-2xl font-bold text-gray-900" id="previewPrincipal">$0</div>
                        </div>
                        
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Purpose</div>
                            <div class="text-gray-900" id="previewPurpose">Not specified</div>
                        </div>
                        
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Flat Fee</div>
                            <div class="text-gray-900" id="previewFee">$0</div>
                        </div>
                        
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Total Amount Due</div>
                            <div class="text-2xl font-bold text-gray-900" id="previewTotal">$0</div>
                        </div>
                        
                        <div>
                            <div class="text-sm text-gray-600 mb-1">Due Date</div>
                            <div class="text-gray-900" id="previewDueDate">Not set</div>
                        </div>
                        
                        <div id="previewLenderSection" class="border-t pt-4 hidden">
                            <div class="text-sm text-gray-600 mb-1">Lender</div>
                            <div class="font-semibold" id="previewLender">-</div>
                        </div>
                        
                        <div id="previewBorrowerSection" class="border-t pt-4 hidden">
                            <div class="text-sm text-gray-600 mb-1">Borrower</div>
                            <div class="font-semibold" id="previewBorrower">-</div>
                        </div>
                        
                        <!-- Selected Plan Display -->
                        <div id="preview-plan-section" class="border-t pt-4 hidden">
                            <div class="text-sm text-gray-600 mb-1">Selected Plan</div>
                            <div class="font-semibold text-blue-600" id="preview-selected-plan">-</div>
                        </div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div class="mt-6 pt-4 border-t">
                        <div class="text-sm text-gray-600 mb-2">Progress</div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 16.67%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Step 1 of 6</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let currentStep = 1;
        const totalSteps = 6;
        let selectedPlan = null;
        let paymentCompleted = false;
        let auditTrail = [];
        
        // Plan pricing
        const plans = {
            basic: { name: 'Basic', price: 19, features: ['basic'] },
            enhanced: { name: 'Enhanced', price: 39, features: ['basic', 'blockchain', 'audit', 'sms', 'ucc'] }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadLenderInfo();
            updatePreview();
            setTodayAsLoanDate();
            generateContractReference();
            addAuditEvent('Contract creation started');
            
            // Initialize payment method change handlers
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', togglePaymentForms);
            });
            
            // Initialize manual payment checkbox
            document.getElementById('payment-confirmed').addEventListener('change', function() {
                const btn = document.getElementById('mark-paid-btn');
                if (this.checked) {
                    btn.disabled = false;
                    btn.className = 'w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 cursor-pointer';
                    btn.textContent = 'Mark as Paid & Continue';
                } else {
                    btn.disabled = true;
                    btn.className = 'w-full px-6 py-3 bg-gray-400 text-white rounded-lg cursor-not-allowed';
                    btn.textContent = 'Mark as Paid & Continue';
                }
            });
        });

        // Billing & Payment Functions
        function selectPlan(planType) {
            selectedPlan = planType;
            
            // Update UI
            document.querySelectorAll('.pricing-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`${planType}-plan`).classList.add('selected');
            
            // Update button states
            document.querySelectorAll('.basic-select-btn, .enhanced-select-btn').forEach(btn => {
                btn.className = btn.className.replace('bg-blue-600 hover:bg-blue-700', 'bg-gray-600 hover:bg-gray-700');
                btn.textContent = btn.textContent.replace('Selected', 'Select');
            });
            
            const selectedBtn = document.querySelector(`.${planType}-select-btn`);
            selectedBtn.className = selectedBtn.className.replace('bg-gray-600 hover:bg-gray-700', 'bg-blue-600 hover:bg-blue-700');
            selectedBtn.textContent = `Selected - ${plans[planType].name}`;
            
            // Show payment summary
            document.getElementById('payment-summary').classList.remove('hidden');
            document.getElementById('selected-plan-name').textContent = plans[planType].name;
            document.getElementById('selected-plan-price').textContent = `$${plans[planType].price}`;
            document.getElementById('total-amount').textContent = `$${plans[planType].price}`;
            
            // Update preview
            document.getElementById('preview-plan-section').classList.remove('hidden');
            document.getElementById('preview-selected-plan').textContent = `${plans[planType].name} ($${plans[planType].price})`;
            
            addAuditEvent(`Selected ${planType} plan`, `Price: $${plans[planType].price}`);
        }

        function togglePaymentForms() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // Hide all forms
            document.getElementById('card-payment-form').classList.add('hidden');
            document.getElementById('paypal-payment-form').classList.add('hidden');
            document.getElementById('manual-payment-form').classList.add('hidden');
            
            // Show selected form
            switch(selectedMethod) {
                case 'card':
                    document.getElementById('card-payment-form').classList.remove('hidden');
                    break;
                case 'paypal':
                    document.getElementById('paypal-payment-form').classList.remove('hidden');
                    initializePayPal();
                    break;
                case 'manual':
                    document.getElementById('manual-payment-form').classList.remove('hidden');
                    updateManualPaymentInfo();
                    break;
            }
            
            addAuditEvent(`Payment method changed to ${selectedMethod}`);
        }

        function initializePayPal() {
            // PayPal integration would go here
            console.log('PayPal integration initialized');
        }

        function updateManualPaymentInfo() {
            if (selectedPlan) {
                document.getElementById('manual-amount').textContent = `$${plans[selectedPlan].price}`;
            }
        }

        function markAsPaid() {
            if (document.getElementById('payment-confirmed').checked) {
                paymentCompleted = true;
                addAuditEvent('Manual payment confirmed');
                nextStep(); // Move to final step
            }
        }

        function processCardPayment() {
            // Stripe payment processing would go here
            // For demo, we'll simulate success
            paymentCompleted = true;
            addAuditEvent('Card payment processed successfully');
            nextStep();
        }

        function generateContractReference() {
            const ref = 'TC-' + Date.now().toString().slice(-6);
            document.getElementById('contract-reference').textContent = ref;
        }

        // Step Navigation
        function nextStep() {
            // Special validation for billing step
            if (currentStep === 4 && !selectedPlan) {
                alert('Please select a plan before proceeding');
                return;
            }
            
            // Process payment at step 5
            if (currentStep === 5 && !paymentCompleted) {
                const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                
                if (selectedMethod === 'card') {
                    processCardPayment();
                    return; // processCardPayment will call nextStep() on success
                } else if (selectedMethod === 'paypal') {
                    // PayPal will handle the callback
                    alert('Please complete PayPal payment to continue');
                    return;
                } else if (selectedMethod === 'manual') {
                    if (!document.getElementById('payment-confirmed').checked) {
                        alert('Please confirm payment has been received');
                        return;
                    }
                    paymentCompleted = true;
                }
            }
            
            if (currentStep < totalSteps) {
                // Validate current step
                if (!validateStep(currentStep)) {
                    return;
                }
                
                addAuditEvent(`Completed step ${currentStep}`);
                
                // Hide current step
                document.getElementById(`form-step-${currentStep}`).classList.add('hidden');
                
                // Update step indicators
                document.getElementById(`step-${currentStep}`).classList.remove('step-active');
                document.getElementById(`step-${currentStep}`).classList.add('step-completed');
                
                currentStep++;
                
                // Show next step
                document.getElementById(`form-step-${currentStep}`).classList.remove('hidden');
                document.getElementById(`step-${currentStep}`).classList.add('step-active');
                
                // Update navigation
                updateStepInfo();
                updateNavButtons();
                updateProgress();
                
                addAuditEvent(`Started step ${currentStep}`);
                
                // Special handling for certain steps
                if (currentStep === 3) {
                    updateReviewSection();
                }
                if (currentStep === 5) {
                    updatePaymentStep();
                }
                if (currentStep === 6) {
                    showEnhancedFeatures();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                // Hide current step
                document.getElementById(`form-step-${currentStep}`).classList.add('hidden');
                
                // Update step indicators
                document.getElementById(`step-${currentStep}`).classList.remove('step-active');
                document.getElementById(`step-${currentStep}`).classList.add('step-inactive');
                
                currentStep--;
                
                // Show previous step
                document.getElementById(`form-step-${currentStep}`).classList.remove('hidden');
                document.getElementById(`step-${currentStep}`).classList.remove('step-completed');
                document.getElementById(`step-${currentStep}`).classList.add('step-active');
                
                // Update navigation
                updateStepInfo();
                updateNavButtons();
                updateProgress();
                
                addAuditEvent(`Returned to step ${currentStep}`);
            }
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    const principal = parseFloat(document.getElementById('principal').value);
                    const dueDate = document.getElementById('dueDate').value;
                    if (!principal || principal <= 0) {
                        alert('Please enter a valid loan amount');
                        return false;
                    }
                    if (!dueDate) {
                        alert('Please select a due date');
                        return false;
                    }
                    return true;
                case 2:
                    const lenderName = document.getElementById('lenderFirstName').value + ' ' + document.getElementById('lenderLastName').value;
                    const borrowerName = document.getElementById('borrowerFirstName').value + ' ' + document.getElementById('borrowerLastName').value;
                    const borrowerEmail = document.getElementById('borrowerEmail').value;
                    const borrowerSSN = document.getElementById('borrowerSSN').value;
                    
                    if (!lenderName.trim() || lenderName.trim().length < 3) {
                        alert('Please enter complete lender information');
                        return false;
                    }
                    if (!borrowerName.trim() || borrowerName.trim().length < 3) {
                        alert('Please enter complete borrower information');
                        return false;
                    }
                    if (!borrowerEmail || !borrowerEmail.includes('@')) {
                        alert('Please enter a valid borrower email address');
                        return false;
                    }
                    if (!borrowerSSN || borrowerSSN.length !== 4) {
                        alert('Please enter the last 4 digits of the borrower\'s SSN for verification');
                        return false;
                    }
                    return true;
                case 3:
                    if (!document.getElementById('agreedToTerms').checked) {
                        alert('Please agree to the terms before proceeding');
                        return false;
                    }
                    if (!document.getElementById('agreedToEsign').checked) {
                        alert('Please agree to electronic signature before proceeding');
                        return false;
                    }
                    return true;
                default:
                    return true;
            }
        }

        function updateStepInfo() {
            const stepLabels = {
                1: { label: 'Loan Details', description: 'Enter the basic loan information' },
                2: { label: 'Party Information', description: 'Lender and borrower details' },
                3: { label: 'Review Contract', description: 'Review all details and agree to terms' },
                4: { label: 'Choose Plan', description: 'Select Basic or Enhanced features' },
                5: { label: 'Payment', description: 'Complete payment to generate contract' },
                6: { label: 'Complete', description: 'Contract ready for signatures' }
            };
            
            document.getElementById('current-step').textContent = currentStep;
            document.getElementById('step-label').textContent = stepLabels[currentStep].label;
            document.getElementById('step-description').textContent = stepLabels[currentStep].description;
        }

        function updateNavButtons() {
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            
            if (currentStep === totalSteps) {
                document.getElementById('nextBtn').classList.add('hidden');
            } else {
                document.getElementById('nextBtn').classList.remove('hidden');
                
                // Update button text based on step
                if (currentStep === 4) {
                    document.getElementById('nextBtn').textContent = 'Continue to Payment';
                } else if (currentStep === 5) {
                    document.getElementById('nextBtn').textContent = 'Process Payment';
                } else {
                    document.getElementById('nextBtn').textContent = 'Next';
                }
            }
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updatePaymentStep() {
            if (selectedPlan) {
                document.getElementById('payment-plan-name').textContent = plans[selectedPlan].name;
                document.getElementById('payment-total').textContent = `$${plans[selectedPlan].price}`;
                document.getElementById('payment-borrower-name').textContent = 
                    document.getElementById('borrowerFirstName').value + ' ' + document.getElementById('borrowerLastName').value;
                document.getElementById('payment-loan-amount').textContent = 
                    '$' + (parseFloat(document.getElementById('principal').value) || 0).toLocaleString();
            }
        }

        function showEnhancedFeatures() {
            if (selectedPlan === 'enhanced') {
                document.getElementById('enhanced-features-display').classList.remove('hidden');
            }
        }

        function updateReviewSection() {
            const reviewSection = document.getElementById('contractReview');
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const fee = parseFloat(document.getElementById('flatFee').value) || 0;
            const total = principal + fee;
            const borrowerSSN = document.getElementById('borrowerSSN').value;
            
            reviewSection.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><strong>Principal:</strong> $${principal.toLocaleString()}</div>
                        <div><strong>Fee:</strong> $${fee.toLocaleString()}</div>
                    </div>
                    <div class="border-t pt-2">
                        <strong>Total Amount Due: $${total.toLocaleString()}</strong>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <strong>Lender:</strong> ${document.getElementById('lenderFirstName').value} ${document.getElementById('lenderLastName').value}
                            <div class="text-sm text-gray-600">${document.getElementById('lenderEmail').value}</div>
                        </div>
                        <div>
                            <strong>Borrower:</strong> ${document.getElementById('borrowerFirstName').value} ${document.getElementById('borrowerLastName').value}
                            <div class="text-sm text-gray-600">${document.getElementById('borrowerEmail').value}</div>
                            ${borrowerSSN ? `<div class="text-xs text-gray-500">SSN: ****${borrowerSSN} (verified)</div>` : ''}
                        </div>
                    </div>
                    <div><strong>Due Date:</strong> ${new Date(document.getElementById('dueDate').value).toLocaleDateString()}</div>
                    <div><strong>Purpose:</strong> ${document.getElementById('purpose').value || 'Not specified'}</div>
                </div>
            `;
        }

        // Final Actions
        function downloadContract() {
            addAuditEvent('Contract PDF downloaded');
            alert('Contract PDF download started...');
        }

        function sendSignatureRequests() {
            addAuditEvent('Signature requests sent to both parties');
            alert('Signature requests sent via email and SMS!');
        }

        function viewAuditTrail() {
            window.location.href = 'audit-trail.html?contract=' + Date.now();
        }

        // Utility Functions
        function addAuditEvent(action, details = '') {
            const event = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                step: currentStep
            };
            auditTrail.push(event);
            console.log('Audit Event:', event);
        }

        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 10);
            
            if (value.length >= 6) {
                value = `(${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6)}`;
            } else if (value.length >= 3) {
                value = `(${value.substring(0, 3)}) ${value.substring(3)}`;
            }
            
            input.value = value;
        }

        function formatSSN(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 4);
            input.value = value;
            
            if (value.length === 4) {
                addAuditEvent('Borrower SSN (last 4) entered for verification');
            }
        }

        function setTodayAsLoanDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('loanDate').value = today;
        }

        function loadLenderInfo() {
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            
            if (profile.firstName) document.getElementById('lenderFirstName').value = profile.firstName;
            if (profile.lastName) document.getElementById('lenderLastName').value = profile.lastName;
            if (profile.email) document.getElementById('lenderEmail').value = profile.email;
            if (profile.phone) document.getElementById('lenderPhone').value = profile.phone;
            
            if (profile.firstName && profile.lastName && profile.email) {
                addAuditEvent('Lender information auto-populated from profile');
            }
            
            updatePreview();
        }

        function updatePreview() {
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const fee = parseFloat(document.getElementById('flatFee').value) || 0;
            const total = principal + fee;
            
            document.getElementById('previewPrincipal').textContent = '$' + principal.toLocaleString();
            document.getElementById('previewFee').textContent = '$' + fee.toLocaleString();
            document.getElementById('previewTotal').textContent = '$' + total.toLocaleString();
            
            const purpose = document.getElementById('purpose').value;
            document.getElementById('previewPurpose').textContent = purpose || 'Not specified';
            
            const dueDate = document.getElementById('dueDate').value;
            if (dueDate) {
                document.getElementById('previewDueDate').textContent = new Date(dueDate).toLocaleDateString();
            }
            
            // Update names if available
            const lenderName = (document.getElementById('lenderFirstName')?.value || '') + ' ' + (document.getElementById('lenderLastName')?.value || '');
            const borrowerName = (document.getElementById('borrowerFirstName')?.value || '') + ' ' + (document.getElementById('borrowerLastName')?.value || '');
            
            if (lenderName.trim().length > 1) {
                document.getElementById('previewLender').textContent = lenderName;
                document.getElementById('previewLenderSection').classList.remove('hidden');
            }
            
            if (borrowerName.trim().length > 1) {
                document.getElementById('previewBorrower').textContent = borrowerName;
                document.getElementById('previewBorrowerSection').classList.remove('hidden');
            }
        }

        function toggleLateFeeOptions() {
            const enabled = document.getElementById('enableLateFee').checked;
            document.getElementById('lateFeeOptions').classList.toggle('hidden', !enabled);
            addAuditEvent(`Late fees ${enabled ? 'enabled' : 'disabled'}`);
        }

        function saveDraft() {
            const formData = {
                currentStep: currentStep,
                selectedPlan: selectedPlan,
                paymentCompleted: paymentCompleted,
                principal: document.getElementById('principal').value,
                // ... other form data
                auditTrail: auditTrail
            };
            localStorage.setItem('trustlend_draft', JSON.stringify(formData));
            addAuditEvent('Draft saved');
            alert('Draft saved successfully!');
        }

        // Navigation JavaScript
        function signOut() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userProfile');
            window.location.href = 'index.html';
        }

        // Initialize navigation
        document.addEventListener('DOMContentLoaded', () => {
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{"firstName":"Demo","lastName":"User","email":"demo@trustlend.app"}');
            
            const userInitials = document.getElementById('userInitials');
            if (userInitials) {
                userInitials.textContent = (userProfile.firstName[0] + userProfile.lastName[0]).toUpperCase();
            }

            const userName = document.getElementById('userName');
            if (userName) {
                userName.textContent = userProfile.firstName;
            }

            const userEmail = document.getElementById('userEmail');
            if (userEmail) {
                userEmail.textContent = userProfile.email;
            }
        });
    </script>
</body>
</html>