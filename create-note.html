<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Promissory Note - TrustLend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        /* FIXED TIER SELECTION STYLES */
        .tier-card.selected {
            border-color: #3b82f6 !important;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .tier-card:not(.selected) {
            border-color: #d1d5db !important;
            background: white;
        }
        
        .tier-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .tier-card:hover:not(.selected) {
            border-color: #9ca3af !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* STEP INDICATOR STYLES */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }
        
        .step.completed:not(:last-child)::after {
            background: #10b981;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }
        
        .step.completed .step-circle {
            background: #10b981;
            color: white;
        }
        
        .step.active .step-circle {
            background: #3b82f6;
            color: white;
        }
        
        .step.inactive .step-circle {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* FORM STYLES */
        .form-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-field.error {
            border-color: #ef4444;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 4px;
        }

        /* SIGNATURE CANVAS */
        .signature-canvas {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: crosshair;
            background: #fafafa;
        }

        /* PAYMENT STYLES */
        .stripe-element {
            background: white;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .stripe-element--focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* UTILITY CLASSES */
        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-900">TrustLend</span>
                </a>
                
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="dashboard.html" class="text-gray-600 hover:text-gray-900">Dashboard</a>
                    <a href="contracts.html" class="text-gray-600 hover:text-gray-900">My Contracts</a>
                    <a href="profile.html" class="text-gray-600 hover:text-gray-900">Profile</a>
                </nav>
                
                <button onclick="saveDraft()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    Save Draft
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Content Area -->
            <div class="lg:col-span-2">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step-1">
                        <div class="step-circle">1</div>
                        <div class="text-sm font-medium">Loan Details</div>
                    </div>
                    <div class="step inactive" id="step-2">
                        <div class="step-circle">2</div>
                        <div class="text-sm font-medium">Party Info</div>
                    </div>
                    <div class="step inactive" id="step-3">
                        <div class="step-circle">3</div>
                        <div class="text-sm font-medium">Review</div>
                    </div>
                    <div class="step inactive" id="step-4">
                        <div class="step-circle">4</div>
                        <div class="text-sm font-medium">Protection Plan</div>
                    </div>
                    <div class="step inactive" id="step-5">
                        <div class="step-circle">5</div>
                        <div class="text-sm font-medium">Signatures</div>
                    </div>
                    <div class="step inactive" id="step-6">
                        <div class="step-circle">6</div>
                        <div class="text-sm font-medium">Complete</div>
                    </div>
                </div>

                <!-- Step 1: Loan Details -->
                <div id="step-content-1" class="step-content">
                    <div class="form-section">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 1: Loan Details</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Loan Amount</label>
                                <input type="text" id="loanAmount" class="input-field" placeholder="$0.00" onInput="formatCurrency(this)">
                                <div id="loanAmount-error" class="error-message hidden"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Interest Rate (%)</label>
                                <input type="number" id="interestRate" class="input-field" placeholder="0.00" step="0.01" min="0" max="100">
                                <div id="interestRate-error" class="error-message hidden"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Loan Purpose</label>
                                <select id="loanPurpose" class="input-field">
                                    <option value="">Select purpose...</option>
                                    <option value="personal">Personal Use</option>
                                    <option value="business">Business Investment</option>
                                    <option value="education">Education</option>
                                    <option value="vehicle">Vehicle Purchase</option>
                                    <option value="home">Home Improvement</option>
                                    <option value="medical">Medical Expenses</option>
                                    <option value="debt">Debt Consolidation</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="investment">Investment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Frequency</label>
                                <select id="paymentFrequency" class="input-field" onChange="updatePaymentSchedule()">
                                    <option value="lump">Lump Sum</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Loan Term</label>
                                <input type="number" id="loanTerm" class="input-field" placeholder="12" min="1" onChange="updatePaymentSchedule()">
                                <small class="text-gray-500">Months (for monthly payments)</small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                                <input type="date" id="dueDate" class="input-field" onChange="updatePaymentSchedule()">
                            </div>
                        </div>
                        
                        <!-- Flat Fee Section -->
                        <div class="mt-6">
                            <div class="flex items-center gap-3 mb-3">
                                <input type="checkbox" id="noFlatFee" class="h-4 w-4 text-blue-600" onChange="toggleFlatFee()">
                                <label for="noFlatFee" class="text-sm font-medium text-gray-700">No flat fee</label>
                            </div>
                            <div id="flatFeeSection">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Flat Fee (Optional)</label>
                                <input type="text" id="flatFee" class="input-field" placeholder="$0.00" onInput="formatCurrency(this)">
                                <small class="text-gray-500">A one-time fee to cover contract processing or platform costs</small>
                            </div>
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                                Next: Party Information
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Party Information -->
                <div id="step-content-2" class="step-content hidden">
                    <div class="form-section">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 2: Party Information</h2>
                        
                        <!-- Lender Information -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Lender Information (You)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="lenderFirstName" class="input-field" onInput="toTitleCase(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="lenderLastName" class="input-field" onInput="toTitleCase(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="lenderEmail" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                    <input type="tel" id="lenderPhone" class="input-field" onInput="formatPhone(this)">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <input type="text" id="lenderAddress" class="input-field">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Borrower Information -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Borrower Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="borrowerFirstName" class="input-field" onInput="toTitleCase(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="borrowerLastName" class="input-field" onInput="toTitleCase(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="borrowerEmail" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                    <input type="tel" id="borrowerPhone" class="input-field" onInput="formatPhone(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                                    <input type="date" id="borrowerDOB" class="input-field" onChange="validateAge(this)">
                                    <div id="age-error" class="error-message hidden"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last 4 of SSN</label>
                                    <input type="text" id="borrowerSSN" class="input-field" maxlength="4" onInput="formatSSN(this)" placeholder="1234">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <input type="text" id="borrowerAddress" class="input-field">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button onclick="prevStep()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold">
                                Previous
                            </button>
                            <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                                Next: Review Contract
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review Contract -->
                <div id="step-content-3" class="step-content hidden">
                    <div class="form-section">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 3: Review Contract</h2>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold text-blue-900 mb-4">Contract Summary</h3>
                            <div id="contractSummary" class="space-y-3 text-sm">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold text-yellow-900 mb-4">Payment Schedule</h3>
                            <div id="paymentSchedule" class="space-y-2 text-sm">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button onclick="prevStep()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold">
                                Previous
                            </button>
                            <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                                Next: Choose Protection Plan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Choose Protection Plan -->
                <div id="step-content-4" class="step-content hidden">
                    <div class="form-section">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 4: Choose Protection Plan</h2>
                        
                        <!-- FIXED TIER CARDS WITH DATA-TIER ATTRIBUTES -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Essential Protection Tier -->
                            <div class="tier-card border-2 border-gray-200 rounded-xl p-6" 
                                 data-tier="essential" 
                                 id="essential-tier-card">
                                <div class="text-center">
                                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Essential Protection</h3>
                                    <div class="text-3xl font-bold text-blue-600 mb-4">$14.99</div>
                                    <p class="text-gray-600 mb-4">Perfect for basic loan agreements</p>
                                    
                                    <ul class="text-left space-y-2">
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Legal contract creation</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Digital signatures (both parties)</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Email delivery & tracking</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">PDF download</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Basic payment reminders</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Standard legal templates</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Maximum Protection Tier -->
                            <div class="tier-card border-2 border-blue-500 rounded-xl p-6 relative" 
                                 data-tier="maximum" 
                                 id="maximum-tier-card">
                                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                    <span class="bg-blue-500 text-white px-4 py-1 rounded-full text-sm font-semibold">
                                        Most Popular
                                    </span>
                                </div>
                                
                                <div class="text-center">
                                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Maximum Protection</h3>
                                    <div class="text-3xl font-bold text-blue-600 mb-4">$29.99</div>
                                    <p class="text-gray-600 mb-4">Complete legal protection & features</p>
                                    
                                    <ul class="text-left space-y-2">
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Everything in Essential +</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Advanced payment reminders</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Premium legal templates</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Blockchain timestamp proof</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Enhanced audit trail</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Priority customer support</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <i class="fas fa-check text-green-600"></i>
                                            <span class="text-sm">Multi-language support</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Section -->
                        <div class="mt-8 p-6 bg-gray-50 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Information</h3>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                                    <div id="card-number" class="stripe-element"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                                    <div id="card-expiry" class="stripe-element"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">CVC</label>
                                    <div id="card-cvc" class="stripe-element"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                                    <input type="text" id="billing-zip" class="input-field" maxlength="10" onInput="formatZip(this)">
                                </div>
                            </div>
                            
                            <div id="card-errors" class="error-message mt-2"></div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button onclick="prevStep()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold">
                                Previous
                            </button>
                            <button onclick="processPayment()" id="payment-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                                <span id="payment-text">Pay & Continue</span>
                                <span id="payment-spinner" class="hidden">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Processing...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Digital Signatures -->
                <div id="step-content-5" class="step-content hidden">
                    <div class="form-section">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 5: Digital Signatures</h2>
                        
                        <!-- Lender Signature -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Signature (Lender)</h3>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                <canvas id="lenderSignature" class="signature-canvas" width="400" height="150"></canvas>
                                <div class="mt-3">
                                    <button onclick="clearSignature('lender')" class="text-blue-600 hover:text-blue-800 text-sm">
                                        Clear Signature
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Borrower Signature Method -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Borrower Signature Method</h3>
                            
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500" onclick="selectSignatureMethod('in-person')">
                                    <div class="flex items-center gap-3">
                                        <input type="radio" name="signatureMethod" value="in-person" id="in-person">
                                        <label for="in-person" class="font-medium">Sign on My Device</label>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">Borrower signs on your phone/tablet right now</p>
                                </div>
                                
                                <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500" onclick="selectSignatureMethod('remote')">
                                    <div class="flex items-center gap-3">
                                        <input type="radio" name="signatureMethod" value="remote" id="remote">
                                        <label for="remote" class="font-medium">Send for Remote Signing</label>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">Send secure link via email/SMS for borrower to sign</p>
                                </div>
                            </div>
                            
                            <!-- In-Person Signature -->
                            <div id="in-person-signature" class="hidden">
                                <h4 class="font-medium text-gray-900 mb-3">Borrower Signature</h4>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                    <canvas id="borrowerSignature" class="signature-canvas" width="400" height="150"></canvas>
                                    <div class="mt-3">
                                        <button onclick="clearSignature('borrower')" class="text-blue-600 hover:text-blue-800 text-sm">
                                            Clear Signature
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Remote Signature -->
                            <div id="remote-signature" class="hidden">
                                <h4 class="font-medium text-gray-900 mb-3">Send Signature Request</h4>
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p class="text-sm text-blue-800 mb-3">
                                        We'll send a secure signing link to the borrower's email and/or phone.
                                    </p>
                                    <div class="flex items-center gap-4">
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" id="send-email" checked class="text-blue-600">
                                            <span class="text-sm">Send to email</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" id="send-sms" class="text-blue-600">
                                            <span class="text-sm">Send via SMS</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button onclick="prevStep()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold">
                                Previous
                            </button>
                            <button onclick="submitContract()" id="submit-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                                <span id="submit-text">Complete Contract</span>
                                <span id="submit-spinner" class="hidden">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Processing...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Contract Complete -->
                <div id="step-content-6" class="step-content hidden">
                    <div class="form-section text-center">
                        <div class="mb-6">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-check text-2xl text-green-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Contract Created Successfully!</h2>
                            <p class="text-gray-600">Your promissory note has been created and is ready for use.</p>
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-4 mb-8">
                            <button onclick="downloadContract()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                                <i class="fas fa-download mr-2"></i>
                                Download PDF
                            </button>
                            <button onclick="viewAuditTrail()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold">
                                <i class="fas fa-list mr-2"></i>
                                View Audit Trail
                            </button>
                            <a href="dashboard.html" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold inline-block">
                                <i class="fas fa-home mr-2"></i>
                                Return to Dashboard
                            </a>
                        </div>
                        
                        <div class="text-left bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-900 mb-2">Next Steps:</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• Contract has been emailed to both parties</li>
                                <li>• Payment reminders will be sent automatically</li>
                                <li>• Track contract status in your Dashboard</li>
                                <li>• Download your copy for your records</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contract Preview Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-24">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Contract Preview</h3>
                    
                    <!-- Selected Plan Section WITH FIXED IDS -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-gray-900 mb-2">Selected Plan</h4>
                        <div class="flex justify-between items-center">
                            <span id="previewTierName" class="text-gray-700">Essential Protection:</span>
                            <span id="previewTierPrice" class="font-semibold text-blue-600">$14.99</span>
                        </div>
                    </div>
                    
                    <!-- Loan Summary -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-900 mb-3">Loan Summary</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Amount:</span>
                                <span id="previewAmount">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Interest Rate:</span>
                                <span id="previewRate">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Payment:</span>
                                <span id="previewPayment">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Due Date:</span>
                                <span id="previewDueDate">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security & Compliance Features WITH FIXED ID -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-900 mb-3">Security & Compliance</h4>
                        <div id="securityFeaturesList" class="space-y-2">
                            <!-- Features will be populated by JavaScript -->
                            <div class="flex items-center gap-2 text-sm mb-2">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                                <span>Legal contract creation</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm mb-2">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                                <span>Digital signatures (both parties)</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm mb-2">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                                <span>Email delivery & tracking</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm mb-2">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                                <span>PDF download</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm mb-2">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                                <span>Basic payment reminders</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm mb-2">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                                <span>Standard legal templates</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pricing Breakdown WITH FIXED IDS -->
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Pricing Breakdown</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Plan fee:</span>
                                <span id="subtotal">$14.99</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Processing fee:</span>
                                <span id="processing-fee">$1.17</span>
                            </div>
                            <div class="flex justify-between font-semibold text-lg border-t border-gray-200 pt-2">
                                <span>Total:</span>
                                <span id="total-amount">$16.16</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load the fixed contracts.js file -->
    <script src="assets/js/contracts.js"></script>
    
    <!-- Main Application JavaScript -->
    <script>
        // Application State
        let currentStep = 1;
        let contractData = {};
        let signatureMethod = '';
        let stripe, cardNumber, cardExpiry, cardCvc;
        
        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            loadLenderInfo();
            initializeStripe();
            initializeSignatureCanvases();
            updatePreview();
            
            // Set default tier selection
            setTimeout(() => {
                selectTier('essential');
            }, 100);
        });
        
        // Step Navigation
        function nextStep() {
            if (validateCurrentStep()) {
                currentStep++;
                updateStepDisplay();
                updateContractSummary();
                updatePreview();
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }
        
        function updateStepDisplay() {
            // Hide all step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show current step content
            document.getElementById(`step-content-${currentStep}`).classList.remove('hidden');
            document.getElementById(`step-content-${currentStep}`).classList.add('fade-in');
            
            // Update step indicators
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step-${i}`);
                step.classList.remove('active', 'completed', 'inactive');
                
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('inactive');
                }
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Form Validation
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return validateLoanDetails();
                case 2:
                    return validatePartyInfo();
                case 3:
                    return true; // Review step
                case 4:
                    return true; // Will be validated on payment
                case 5:
                    return validateSignatures();
                default:
                    return true;
            }
        }
        
        function validateLoanDetails() {
            let isValid = true;
            
            const amount = document.getElementById('loanAmount').value;
            if (!amount || parseFloat(amount.replace(/[$,]/g, '')) <= 0) {
                showFieldError('loanAmount', 'Please enter a valid loan amount');
                isValid = false;
            }
            
            const rate = document.getElementById('interestRate').value;
            if (!rate || parseFloat(rate) < 0) {
                showFieldError('interestRate', 'Please enter a valid interest rate');
                isValid = false;
            }
            
            const purpose = document.getElementById('loanPurpose').value;
            if (!purpose) {
                showFieldError('loanPurpose', 'Please select a loan purpose');
                isValid = false;
            }
            
            const dueDate = document.getElementById('dueDate').value;
            if (!dueDate) {
                showFieldError('dueDate', 'Please select a due date');
                isValid = false;
            }
            
            return isValid;
        }
        
        function validatePartyInfo() {
            let isValid = true;
            
            const requiredFields = [
                'lenderFirstName', 'lenderLastName', 'lenderEmail', 'lenderPhone',
                'borrowerFirstName', 'borrowerLastName', 'borrowerEmail', 'borrowerPhone'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showFieldError(fieldId, 'This field is required');
                    isValid = false;
                }
            });
            
            return isValid;
        }
        
        function validateSignatures() {
            const method = document.querySelector('input[name="signatureMethod"]:checked');
            if (!method) {
                alert('Please select a signature method');
                return false;
            }
            
            if (method.value === 'in-person') {
                // Check if both signatures are present
                const lenderCanvas = document.getElementById('lenderSignature');
                const borrowerCanvas = document.getElementById('borrowerSignature');
                
                if (!isCanvasSigned(lenderCanvas) || !isCanvasSigned(borrowerCanvas)) {
                    alert('Both signatures are required');
                    return false;
                }
            } else {
                // Check if lender signature is present
                const lenderCanvas = document.getElementById('lenderSignature');
                if (!isCanvasSigned(lenderCanvas)) {
                    alert('Your signature is required');
                    return false;
                }
            }
            
            return true;
        }
        
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(`${fieldId}-error`);
            
            field.classList.add('error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
            
            setTimeout(() => {
                field.classList.remove('error');
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            }, 5000);
        }
        
        // Form Helpers
        function formatCurrency(input) {
            let value = input.value.replace(/[^\d.]/g, '');
            if (value) {
                value = parseFloat(value).toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD'
                });
                input.value = value;
            }
            updatePreview();
        }
        
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = `(${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 10)}`;
            } else if (value.length >= 3) {
                value = `(${value.substring(0, 3)}) ${value.substring(3)}`;
            }
            input.value = value;
        }
        
        function formatSSN(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 4);
            input.value = value;
        }
        
        function formatZip(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 9);
            }
            input.value = value;
        }
        
        function toTitleCase(input) {
            input.value = input.value.replace(/\w\S*/g, (txt) => {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }
        
        function validateAge(input) {
            const birthDate = new Date(input.value);
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            if (age < 18) {
                showFieldError('borrowerDOB', 'Borrower must be at least 18 years old');
            }
        }
        
        function toggleFlatFee() {
            const checkbox = document.getElementById('noFlatFee');
            const feeSection = document.getElementById('flatFeeSection');
            const feeInput = document.getElementById('flatFee');
            
            if (checkbox.checked) {
                feeSection.style.opacity = '0.5';
                feeInput.disabled = true;
                feeInput.value = '';
            } else {
                feeSection.style.opacity = '1';
                feeInput.disabled = false;
            }
        }
        
        // Payment Schedule
        function updatePaymentSchedule() {
            const frequency = document.getElementById('paymentFrequency').value;
            const term = document.getElementById('loanTerm').value;
            const amount = document.getElementById('loanAmount').value;
            const rate = document.getElementById('interestRate').value;
            
            updatePreview();
        }
        
        // Preview Updates
        function updatePreview() {
            const amount = document.getElementById('loanAmount').value || '-';
            const rate = document.getElementById('interestRate').value || '-';
            const frequency = document.getElementById('paymentFrequency').value || 'lump';
            const dueDate = document.getElementById('dueDate').value || '-';
            
            document.getElementById('previewAmount').textContent = amount;
            document.getElementById('previewRate').textContent = rate ? rate + '%' : '-';
            document.getElementById('previewPayment').textContent = frequency === 'lump' ? 'Lump Sum' : 'Monthly';
            document.getElementById('previewDueDate').textContent = dueDate ? new Date(dueDate).toLocaleDateString() : '-';
        }
        
        function updateContractSummary() {
            const summaryDiv = document.getElementById('contractSummary');
            const scheduleDiv = document.getElementById('paymentSchedule');
            
            if (!summaryDiv || currentStep < 3) return;
            
            const lenderName = `${document.getElementById('lenderFirstName').value} ${document.getElementById('lenderLastName').value}`.trim();
            const borrowerName = `${document.getElementById('borrowerFirstName').value} ${document.getElementById('borrowerLastName').value}`.trim();
            const amount = document.getElementById('loanAmount').value;
            const rate = document.getElementById('interestRate').value;
            const purpose = document.getElementById('loanPurpose').value;
            const frequency = document.getElementById('paymentFrequency').value;
            const dueDate = document.getElementById('dueDate').value;
            
            summaryDiv.innerHTML = `
                <div><strong>Lender:</strong> ${lenderName || 'Not specified'}</div>
                <div><strong>Borrower:</strong> ${borrowerName || 'Not specified'}</div>
                <div><strong>Loan Amount:</strong> ${amount || 'Not specified'}</div>
                <div><strong>Interest Rate:</strong> ${rate ? rate + '%' : 'Not specified'}</div>
                <div><strong>Purpose:</strong> ${purpose || 'Not specified'}</div>
                <div><strong>Payment Type:</strong> ${frequency === 'lump' ? 'Lump Sum' : 'Installments'}</div>
                <div><strong>Due Date:</strong> ${dueDate ? new Date(dueDate).toLocaleDateString() : 'Not specified'}</div>
            `;
            
            // Update payment schedule
            if (frequency === 'lump') {
                scheduleDiv.innerHTML = `
                    <div class="text-center">
                        <strong>Single Payment Due:</strong> ${dueDate ? new Date(dueDate).toLocaleDateString() : 'Not specified'}
                    </div>
                `;
            } else {
                scheduleDiv.innerHTML = `
                    <div class="text-center">
                        <strong>Payment Schedule:</strong> ${frequency} payments starting ${dueDate ? new Date(dueDate).toLocaleDateString() : 'TBD'}
                    </div>
                `;
            }
        }
        
        // Lender Info Loading
        function loadLenderInfo() {
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            
            if (profile.firstName) document.getElementById('lenderFirstName').value = profile.firstName;
            if (profile.lastName) document.getElementById('lenderLastName').value = profile.lastName;
            if (profile.email) document.getElementById('lenderEmail').value = profile.email;
            if (profile.phone) document.getElementById('lenderPhone').value = profile.phone;
            if (profile.address) document.getElementById('lenderAddress').value = profile.address;
        }
        
        // Stripe Payment Integration
        function initializeStripe() {
            stripe = Stripe('pk_test_demo_key'); // Replace with your actual publishable key
            const elements = stripe.elements();
            
            cardNumber = elements.create('cardNumber');
            cardExpiry = elements.create('cardExpiry');
            cardCvc = elements.create('cardCvc');
            
            cardNumber.mount('#card-number');
            cardExpiry.mount('#card-expiry');
            cardCvc.mount('#card-cvc');
            
            cardNumber.on('change', handleCardChange);
        }
        
        function handleCardChange(event) {
            const errorDiv = document.getElementById('card-errors');
            if (event.error) {
                errorDiv.textContent = event.error.message;
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
        }
        
        async function processPayment() {
            const paymentBtn = document.getElementById('payment-btn');
            const paymentText = document.getElementById('payment-text');
            const paymentSpinner = document.getElementById('payment-spinner');
            
            paymentText.classList.add('hidden');
            paymentSpinner.classList.remove('hidden');
            paymentBtn.disabled = true;
            
            // Simulate payment processing
            setTimeout(() => {
                paymentText.classList.remove('hidden');
                paymentSpinner.classList.add('hidden');
                paymentBtn.disabled = false;
                
                // Show success message
                alert('Payment processed successfully!');
                nextStep();
            }, 2000);
        }
        
        // Signature Functionality
        function initializeSignatureCanvases() {
            const lenderCanvas = document.getElementById('lenderSignature');
            const borrowerCanvas = document.getElementById('borrowerSignature');
            
            setupSignatureCanvas(lenderCanvas);
            setupSignatureCanvas(borrowerCanvas);
        }
        
        function setupSignatureCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                draw(e);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';
                
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    ctx.beginPath();
                }
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }
        
        function clearSignature(type) {
            const canvas = document.getElementById(`${type}Signature`);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        function isCanvasSigned(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] > 0) return true;
            }
            return false;
        }
        
        function selectSignatureMethod(method) {
            signatureMethod = method;
            document.getElementById(method).checked = true;
            
            document.getElementById('in-person-signature').classList.add('hidden');
            document.getElementById('remote-signature').classList.add('hidden');
            
            document.getElementById(`${method}-signature`).classList.remove('hidden');
        }
        
        // Contract Submission
        async function submitContract() {
            if (!validateSignatures()) return;
            
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            const submitSpinner = document.getElementById('submit-spinner');
            
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            submitBtn.disabled = true;
            
            // Simulate contract processing
            setTimeout(() => {
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                submitBtn.disabled = false;
                
                nextStep(); // Go to completion step
            }, 3000);
        }
        
        // Save Draft
        function saveDraft() {
            const formData = {
                currentStep,
                timestamp: new Date().toISOString(),
                // Collect all form data
                loanAmount: document.getElementById('loanAmount').value,
                interestRate: document.getElementById('interestRate').value,
                loanPurpose: document.getElementById('loanPurpose').value,
                // ... add all other fields
            };
            
            localStorage.setItem('trustlend_draft', JSON.stringify(formData));
            
            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = 'Draft saved successfully!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Final Actions
        function downloadContract() {
            alert('Contract PDF download will start...');
            // Implementation would generate and download PDF
        }
        
        function viewAuditTrail() {
            window.open('audit-trail.html', '_blank');
        }
    </script>
</body>
</html>
